<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMAS KOESMA - Enterprise</title>
    <link rel="icon" href="https://github.com/koesmasurat/simas/blob/main/logo%20rsud%202%20png.png?raw=true" type="image/png">
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Playfair+Display:ital@1&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.1/tsparticles.bundle.min.js"></script>
    
    <style>
        :root { --glass-bg: rgba(255, 255, 255, 0.1); --glass-border: rgba(255, 255, 255, 0.2); --text-light: #f8f9fa; --emerald-accent: #f97316; --blue-accent: #3b82f6; --sidebar-width: 310px; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #9a3412 0%, #0f172a 100%); background-attachment: fixed; color: var(--text-light); min-height: 100vh; overflow-x: hidden; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(12px); border: 1px solid var(--glass-border); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .white-panel { background: #ffffff !important; color: #333 !important; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); overflow: hidden; }
        .white-panel .card { border: none; box-shadow: none; }
        .white-panel h2, .white-panel h3, .white-panel label { color: #333 !important; }
        
        /* Dark Transparent Card for Input Forms */
        .glass-form-card {
            background: rgba(0, 0, 0, 0.6) !important;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white !important;
            padding: 20px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }
        .glass-form-card h3 { color: white !important; }
        .glass-form-card label { color: #f8f9fa !important; }
        .glass-form-card .form-control, .glass-form-card .form-select {
            background-color: #ffffff;
            color: #333333;
            border: none;
        }

        #loginSection { height: 100vh; display: flex; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 200; }
        .login-card { width: 100%; max-width: 450px; padding: 2.5rem; text-align: center; border-radius: 16px; position: relative; z-index: 201; }
        #door-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: flex; pointer-events: none; }
        .door-panel { width: 50%; height: 100%; background: linear-gradient(135deg, #9a3412 0%, #0f172a 100%); position: relative; transition: transform 1.5s cubic-bezier(0.77, 0, 0.175, 1); box-shadow: 0 0 50px rgba(0,0,0,0.5); z-index: 101; }
        .door-open #door-left { transform: translateX(-100%); } .door-open #door-right { transform: translateX(100%); }
        
        /* Particles container (z-index adjusted to be behind login card but visible) */
        #tsparticles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 150; pointer-events: none; transition: opacity 1.5s, filter 1.5s; }
        #tsparticles.in-background { z-index: 0 !important; opacity: 0.2 !important; filter: blur(2px); }
        
        #appContent { display: none; width: 100%; min-height: 100vh; position: relative; z-index: 50; } .wrapper { display: flex; width: 100%; align-items: stretch; }
        #sidebar { min-width: var(--sidebar-width); max-width: var(--sidebar-width); background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(15px); border-right: 1px solid var(--glass-border); position: fixed; height: 100vh; z-index: 1000; display: flex; flex-direction: column; transition: all 0.3s; }
        #sidebar.toggled { margin-left: calc(var(--sidebar-width) * -1); } .sidebar-scroll { flex-grow: 1; overflow-y: auto; padding: 1rem; scrollbar-width: thin; }
        #content { width: 100%; padding: 20px; margin-left: var(--sidebar-width); transition: all 0.3s; } #content.toggled { margin-left: 0; }
        .nav-link { color: rgba(255,255,255,0.8); border-radius: 6px; padding: 10px 15px; margin-bottom: 4px; font-size: 0.9rem; transition: all 0.2s; display: flex; align-items: center; }
        .nav-link:hover { background: rgba(255,255,255,0.15); color: #fff; padding-left: 20px; } .nav-link.active { background: linear-gradient(90deg, var(--emerald-accent), transparent); color: #fff; border-left: 4px solid #fff; } .nav-link i { width: 25px; text-align: center; margin-right: 10px; }
        .submenu { padding-left: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 5px; } .submenu .nav-link { font-size: 0.85em; padding: 8px 12px; }
        .badge-count { font-size: 0.7rem; padding: 2px 7px; border-radius: 10px; margin-left: auto; background: var(--blue-accent); display: none; } .badge-count.has-data { display: inline-block; background: #ef4444; animation: pulse 2s infinite; }
        .table { font-size: 0.85rem; } .table th { background-color: #f1f5f9; color: #475569; font-weight: 600; }
        .modal-content { background: #fff; color: #333; }
        .perm-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 0.8rem; }
        .perm-category { grid-column: span 2; font-weight: bold; margin-top: 15px; margin-bottom: 5px; color: var(--emerald-accent); border-bottom: 1px solid #eee; }
        .tab-pane { display: none; } .tab-pane.active { display: block; animation: fadeIn 0.4s; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .restricted-feature { display: none !important; } #loadingOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99999; display: none; justify-content: center; align-items: center; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .user-list-item { padding: 5px 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; }
        .user-list-item:hover { background-color: #f8f9fa; }
    </style>
</head>
<body>
    <div id="tsparticles"></div>
    <div id="door-overlay"><div id="door-left" class="door-panel"></div><div id="door-right" class="door-panel"></div></div>
    <div id="loadingOverlay"><div class="text-center"><div class="spinner-border text-light mb-3" style="width: 3rem; height: 3rem;"></div><h5 class="text-white">Memproses Data...</h5></div></div>

    <datalist id="listKodeKlarifikasi"></datalist>

    <div id="loginSection">
        <div class="glass-panel login-card">
            <img src="https://github.com/koesmasurat/simas/blob/main/logo%20rsud%202%20png.png?raw=true" width="100" class="mb-3">
            <h3 class="fw-bold text-white">SIMAS KOESMA</h3>
            <p class="text-white-50">Sistem Informasi Manajemen Arsip Surat</p>
            <div id="quoteContainer" class="my-4 text-warning fst-italic small border-top border-bottom border-white-50 py-2"><span id="quoteText">"Memuat kata bijak..."</span></div>
            <div class="d-flex justify-content-center">
                <div id="g_id_onload" data-client_id="783459415718-mp0vsmd2lopajf2ut0aqc6drjrs95pu8.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_prompt="false"></div>
                <div class="g_id_signin" data-type="standard" data-size="large" data-theme="filled_blue" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
            </div>
        </div>
    </div>

    <div id="appContent">
        <div class="wrapper">
            <nav id="sidebar">
                <div class="p-3 text-center border-bottom border-white-50">
                    <div class="d-flex align-items-center justify-content-center gap-2 mb-2">
                        <img src="https://github.com/koesmasurat/simas/blob/main/logo%20rsud%202%20png.png?raw=true" width="40">
                        <div class="text-start lh-1"><div class="fw-bold small">RSUD dr. R. KOESMA</div><div class="text-warning" style="font-size: 0.7rem;">SIMAS Enterprise</div></div>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded p-2 mt-2"><div class="fw-bold text-truncate" id="userDisplayName">Pengguna</div><div class="badge bg-info text-dark" id="userRoleBadge">Role</div></div>
                </div>
                
                <div class="sidebar-scroll">
                    <button class="nav-link w-100 text-start" id="btn-home" onclick="activateTab('home-content', this)"><i class="fas fa-home"></i> Beranda</button>
                    
                    <div class="my-2 border-top border-white-50"></div>
                    <button class="nav-link w-100 text-start" onclick="openAdvancedSearch()"><i class="fas fa-search"></i> Pencarian Lanjut (OCR)</button>
                    <div class="my-2 border-top border-white-50"></div>

                    <small class="text-white-50 text-uppercase fw-bold mb-2 d-block px-2" style="font-size:0.7rem;">Input Data</small>
                    <button class="nav-link w-100 text-start restricted-feature" data-perm="input_masuk" onclick="activateTab('input-masuk-content', this); autoFillAgendaMasuk(); setDefaultDatesMasuk();"><i class="fas fa-envelope-open-text"></i> Surat Masuk</button>
                    <button class="nav-link w-100 text-start restricted-feature" data-perm="input_keluar" onclick="activateTab('input-keluar-content', this); autoFillAgendaKeluar();"><i class="fas fa-paper-plane"></i> Surat Keluar</button>
                    
                    <div class="my-2 border-top border-white-50"></div>
                    <small class="text-white-50 text-uppercase fw-bold mb-2 d-block px-2" style="font-size:0.7rem;">Inbox & Disposisi</small>
                    
                    <button class="nav-link w-100 text-start restricted-feature" data-perm="inbox_direktur" onclick="openDisposisiPage('direktur', this)">Inbox Direktur <span class="badge-count" id="count-direktur">0</span></button>
                    <button class="nav-link w-100 text-start restricted-feature" data-perm="inbox_wadir_adm" onclick="openDisposisiPage('wadir_adm', this)">Inbox Wadir Adm & Keu <span class="badge-count" id="count-wadir_adm">0</span></button>
                    <button class="nav-link w-100 text-start restricted-feature" data-perm="inbox_wadir_pel" onclick="openDisposisiPage('wadir_pel', this)">Inbox Wadir Pelayanan <span class="badge-count" id="count-wadir_pel">0</span></button>
                    
                    <a class="nav-link w-100 text-start" data-bs-toggle="collapse" href="#subKabag" role="button">Inbox Kabag/Kabid <i class="fas fa-chevron-down ms-auto small"></i></a>
                    <div class="collapse submenu" id="subKabag">
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="inbox_kabag_umum" onclick="openDisposisiPage('kabag_umum', this)">Kabag Umum <span class="badge-count" id="count-kabag_umum">0</span></button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="inbox_kabag_keu" onclick="openDisposisiPage('kabag_keuangan', this)">Kabag Keu <span class="badge-count" id="count-kabag_keuangan">0</span></button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="inbox_kabag_prog" onclick="openDisposisiPage('kabag_progpel', this)">Kabag Progpel <span class="badge-count" id="count-kabag_progpel">0</span></button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="inbox_kabid_yanmed" onclick="openDisposisiPage('kabid_yanmed', this)">Kabid Yanmed <span class="badge-count" id="count-kabid_yanmed">0</span></button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="inbox_kabid_penunjang" onclick="openDisposisiPage('kabid_penunjang', this)">Kabid Penunjang <span class="badge-count" id="count-kabid_penunjang">0</span></button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="inbox_kabid_kep" onclick="openDisposisiPage('kabid_keperawatan', this)">Kabid Kep <span class="badge-count" id="count-kabid_keperawatan">0</span></button>
                    </div>

                    <div class="my-2 border-top border-white-50"></div>
                    <a class="nav-link w-100 text-start text-info" data-bs-toggle="collapse" href="#menuArsipMasuk" role="button"><i class="fas fa-folder-open"></i> Arsip Masuk <i class="fas fa-chevron-down ms-auto small"></i></a>
                    <div class="collapse submenu" id="menuArsipMasuk">
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_masuk_all" onclick="openArsipPage('masuk', 'all', this)">All (Semua)</button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_masuk_direktur" onclick="openArsipPage('masuk', 'direktur', this)">Direktur</button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_masuk_wadir_adm" onclick="openArsipPage('masuk', 'wadir_adm', this)">Wadir Adm</button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_masuk_wadir_pel" onclick="openArsipPage('masuk', 'wadir_pel', this)">Wadir Pel</button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_masuk_kabag_umum" onclick="openArsipPage('masuk', 'kabag_umum', this)">Kabag Umum</button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_masuk_kabag_keu" onclick="openArsipPage('masuk', 'kabag_keu', this)">Kabag Keuangan</button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_masuk_kabag_prog" onclick="openArsipPage('masuk', 'kabag_prog', this)">Kabag Program</button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_masuk_kabid_yanmed" onclick="openArsipPage('masuk', 'kabid_yanmed', this)">Kabid Medik</button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_masuk_kabid_penunjang" onclick="openArsipPage('masuk', 'kabid_penunjang', this)">Kabid Penunjang</button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_masuk_kabid_kep" onclick="openArsipPage('masuk', 'kabid_kep', this)">Kabid Keperawatan</button>
                    </div>

                    <a class="nav-link w-100 text-start text-success" data-bs-toggle="collapse" href="#menuArsipKeluar" role="button"><i class="fas fa-archive"></i> Arsip Keluar <i class="fas fa-chevron-down ms-auto small"></i></a>
                    <div class="collapse submenu" id="menuArsipKeluar">
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_keluar_all" onclick="openArsipPage('keluar', 'all', this)">All (Semua)</button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_keluar_direktur" onclick="openArsipPage('keluar', 'direktur', this)">Direktur</button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_keluar_wadir_adm" onclick="openArsipPage('keluar', 'wadir_adm', this)">Wadir Adm</button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_keluar_wadir_pel" onclick="openArsipPage('keluar', 'wadir_pel', this)">Wadir Pel</button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_keluar_kabag_umum" onclick="openArsipPage('keluar', 'kabag_umum', this)">Kabag Umum</button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_keluar_kabag_keu" onclick="openArsipPage('keluar', 'kabag_keu', this)">Kabag Keuangan</button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_keluar_kabag_prog" onclick="openArsipPage('keluar', 'kabag_prog', this)">Kabag Program</button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_keluar_kabid_yanmed" onclick="openArsipPage('keluar', 'kabid_yanmed', this)">Kabid Medik</button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_keluar_kabid_penunjang" onclick="openArsipPage('keluar', 'kabid_penunjang', this)">Kabid Penunjang</button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_keluar_kabid_kep" onclick="openArsipPage('keluar', 'kabid_kep', this)">Kabid Keperawatan</button>
                    </div>

                    <div class="my-2 border-top border-white-50"></div>
                    <button class="nav-link w-100 text-start text-danger restricted-feature" data-perm="setting_user" onclick="openSettingsPage(this)"><i class="fas fa-users-cog"></i> Pengaturan</button>
                </div>
                <div class="p-3 bg-dark bg-opacity-25 border-top border-white-50"><button class="btn btn-danger w-100" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Keluar</button></div>
            </nav>

            <div id="content">
                <button type="button" id="sidebarCollapse" class="btn btn-outline-light mb-3"><i class="fas fa-bars"></i> Menu</button>
                <div class="tab-content">
                    <div class="tab-pane white-panel p-4" id="home-content">
                        <div class="text-center py-5">
                            <h2 class="fw-bold text-primary mb-3">Selamat Datang di SIMAS KOESMA</h2>
                            <p class="lead mb-4">Sistem Informasi Manajemen Arsip Surat</p>
                            <div class="alert alert-info d-inline-block text-start">
                                <strong><i class="fas fa-info-circle me-2"></i>Status Akun Anda:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>Nama: <span id="homeDisplayName" class="fw-bold">...</span></li>
                                    <li>Role: <span id="homeRoleBadge" class="badge bg-secondary">...</span></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- SEARCH RESULT -->
                    <div class="tab-pane white-panel p-4" id="search-content">
                        <h3 class="fw-bold mb-4 border-bottom pb-2">Hasil Pencarian</h3>
                        <div class="table-responsive"><table id="tableSearch" class="table table-hover table-bordered w-100 align-middle"><thead class="table-light"><tr><th>Tgl</th><th>Agenda</th><th>Ref</th><th>Perihal</th><th>OCR</th><th>Aksi</th></tr></thead><tbody></tbody></table></div>
                    </div>

                    <!-- INPUT MASUK - DARK GLASS THEME -->
                    <div class="tab-pane glass-form-card" id="input-masuk-content">
                        <h3 class="fw-bold mb-4 border-bottom pb-2 text-white">Catat Surat Masuk</h3>
                        <form id="formSuratMasuk">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">No. Agenda</label>
                                    <input type="number" class="form-control" name="noAgenda" id="inNoAgenda" required>
                                    <small class="text-white-50">Otomatis terisi urutan terakhir</small>
                                </div>
                                <div class="col-md-4"><label class="form-label fw-bold">Tgl Surat</label><input type="date" class="form-control" name="tglSurat" required></div>
                                <div class="col-md-4"><label class="form-label fw-bold">Tgl Terima</label><input type="date" class="form-control" name="tglTerima" required></div>
                                <div class="col-md-6"><label class="form-label fw-bold">No. Surat</label><input type="text" class="form-control" name="noSurat" required></div>
                                <div class="col-md-6"><label class="form-label fw-bold">Pengirim</label><input type="text" class="form-control" name="pengirim" required></div>
                                <div class="col-12"><label class="form-label fw-bold">Kode Klarifikasi</label><input type="text" class="form-control" name="kodeKlarifikasi" list="listKodeKlarifikasi" placeholder="Ketik kode atau keterangan..."></div>
                                <div class="col-12"><label class="form-label fw-bold">Perihal</label><textarea class="form-control" name="perihal" rows="3" required></textarea></div>
                                <div class="col-12"><label class="form-label fw-bold">Upload File (PDF/IMG) - OCR Aktif</label><input type="file" class="form-control" id="fileSuratMasuk"></div>
                                <div class="col-12 mt-4"><button type="submit" class="btn btn-primary w-100 py-2">Simpan</button></div>
                            </div>
                        </form>
                    </div>

                    <!-- INPUT KELUAR - DARK GLASS THEME -->
                    <div class="tab-pane glass-form-card" id="input-keluar-content">
                        <h3 class="fw-bold mb-4 border-bottom pb-2 text-white">Catat Surat Keluar</h3>
                        <form id="formSuratKeluar">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">No. Agenda</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="noAgenda" id="outNoAgenda" required>
                                        <button class="btn btn-warning fw-bold" type="button" onclick="openBookingModal('keluar')">Booking</button>
                                    </div>
                                </div>
                                <div class="col-md-6"><label class="form-label fw-bold">Tanggal</label><input type="date" class="form-control" name="tglSurat" required></div>
                                <div class="col-12"><label class="form-label fw-bold">Tujuan</label><input type="text" class="form-control" name="tujuan" required></div>
                                <div class="col-12"><label class="form-label fw-bold">Pembuat Surat</label><input type="text" class="form-control" name="pembuat"></div>
                                <div class="col-12"><label class="form-label fw-bold">Perihal</label><textarea class="form-control" name="perihal" rows="3" required></textarea></div>
                                <div class="col-12"><label class="form-label fw-bold">Upload File</label><input type="file" class="form-control" id="fileSuratKeluar"></div>
                                <div class="col-12 mt-4"><button type="submit" class="btn btn-success w-100 py-2">Simpan</button></div>
                            </div>
                        </form>
                    </div>

                    <!-- INBOX -->
                    <div class="tab-pane white-panel p-4" id="disposisi-container">
                        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                            <h3 class="fw-bold m-0">Inbox: <span class="text-warning" id="dispPageTitle">Direktur</span></h3>
                            <button class="btn btn-outline-primary btn-sm" onclick="refreshCurrentDisposisi()">Refresh</button>
                        </div>
                        <div class="table-responsive"><table id="tableDisposisi" class="table table-hover table-bordered w-100 align-middle"><thead class="table-light"><tr><th>Tanggal</th><th>Agenda</th><th>Pengirim</th><th>Perihal</th><th width="10%">Aksi</th></tr></thead><tbody></tbody></table></div>
                    </div>

                    <!-- ARSIP -->
                    <div class="tab-pane white-panel p-4" id="arsip-masuk-container">
                        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2"><h3 class="fw-bold m-0">Arsip Masuk</h3><button class="btn btn-outline-info btn-sm" onclick="loadArsipMasuk()">Refresh</button></div>
                        <div class="table-responsive"><table id="tableArsipMasuk" class="table table-hover table-bordered w-100 align-middle"><thead class="table-light"><tr><th>Tgl Terima</th><th>Agenda</th><th>Pengirim</th><th>Perihal</th><th>Status</th><th>File</th><th>Kode</th><th width="5%">Aksi</th></tr></thead><tbody></tbody></table></div>
                    </div>
                    <div class="tab-pane white-panel p-4" id="arsip-keluar-container">
                        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2"><h3 class="fw-bold m-0">Arsip Keluar</h3><button class="btn btn-outline-success btn-sm" onclick="loadArsipKeluar()">Refresh</button></div>
                        <div class="table-responsive"><table id="tableArsipKeluar" class="table table-hover table-bordered w-100 align-middle"><thead class="table-light"><tr><th>Agenda</th><th>Tgl Surat</th><th>Tujuan</th><th>Perihal</th><th>Status</th><th>File</th><th width="5%">Aksi</th></tr></thead><tbody></tbody></table></div>
                    </div>

                    <!-- SETTINGS -->
                    <div class="tab-pane white-panel p-4" id="settings-content">
                        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2"><h3 class="fw-bold m-0 text-danger">Pengaturan</h3><div><button class="btn btn-primary btn-sm me-2" onclick="loadUsers()">Reload User</button><button class="btn btn-warning btn-sm" onclick="loadStorageStats()">Cek Storage</button></div></div>
                        <div class="card mb-4 border-warning shadow-sm">
                            <div class="card-header bg-warning text-dark fw-bold">Infrastruktur Penyimpanan</div>
                            <div class="card-body">
                                <div class="row g-3 text-center mb-3">
                                     <div class="col-md-4"><div class="p-2 border rounded bg-light"><h6>Server Utama (A)</h6><h5 id="disp-quota-A">...</h5><div class="progress" style="height:5px"><div id="prog-A" class="progress-bar bg-primary" style="width:0%"></div></div></div></div>
                                     <div class="col-md-4"><div class="p-2 border rounded bg-light"><h6>Gudang 1 (B)</h6><h5 id="disp-quota-B">...</h5><div class="progress" style="height:5px"><div id="prog-B" class="progress-bar bg-success" style="width:0%"></div></div></div></div>
                                     <div class="col-md-4"><div class="p-2 border rounded bg-light"><h6>Gudang 2 (C)</h6><h5 id="disp-quota-C">...</h5><div class="progress" style="height:5px"><div id="prog-C" class="progress-bar bg-warning" style="width:0%"></div></div></div></div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded">
                                    <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="switchFailover" onchange="saveStorageSettings()"><label class="form-check-label fw-bold" for="switchFailover">Failover Otomatis</label></div>
                                    <select class="form-select form-select-sm w-auto" id="selectActiveNode" onchange="saveStorageSettings()"><option value="0">Server Utama</option><option value="1">Gudang 1</option><option value="2">Gudang 2</option></select>
                                </div>
                            </div>
                        </div>
                        <h5 class="fw-bold mb-3">Daftar Pengguna</h5>
                        <div class="table-responsive"><table id="tableUsers" class="table table-striped w-100 align-middle"><thead class="table-dark"><tr><th>Email</th><th>Nama</th><th>Role</th><th>Status</th><th>Aksi</th></tr></thead><tbody></tbody></table></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL SEARCH ADVANCED -->
    <div class="modal fade" id="modalSearchAdvanced" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">Pencarian Lanjut (OCR)</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body">
        <form id="formSearchAdvanced">
            <div class="mb-3"><label class="form-label small fw-bold">Kategori</label><select class="form-select" id="sa_category"><option value="masuk">Surat Masuk</option><option value="keluar">Surat Keluar</option></select></div>
            <div class="mb-3"><label class="form-label small fw-bold">Kata Kunci (Termasuk Isi File/OCR)</label><input type="text" class="form-control" id="sa_keyword" placeholder="Contoh: Undangan, Laporan..."></div>
            <div class="row g-2"><div class="col-6"><label class="form-label small fw-bold">Dari Tanggal</label><input type="date" class="form-control" id="sa_start"></div><div class="col-6"><label class="form-label small fw-bold">Sampai Tanggal</label><input type="date" class="form-control" id="sa_end"></div></div>
        </form>
    </div><div class="modal-footer"><button type="button" class="btn btn-primary w-100" onclick="submitSearchAdvanced()">Cari Data</button></div></div></div></div>

    <!-- MODAL BOOKING AGENDA (Only for Surat Keluar now, generally) -->
    <div class="modal fade" id="modalBooking" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Booking Nomor Agenda (Keluar)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="bookingCategory" value="keluar">
                    <div class="text-center mb-4">
                        <small>Nomor Agenda Terakhir:</small>
                        <h2 id="lastAgendaDisplay" class="fw-bold text-primary">...</h2>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Nomor yang ingin dibooking/dipakai:</label>
                        <input type="number" class="form-control form-control-lg text-center fw-bold" id="bookingValue">
                        <input type="text" class="form-control mt-2" id="bookingNote" placeholder="Catatan Booking (Opsional)">
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-success fw-bold" onclick="saveBooking()">Simpan Booking (Amankan Slot)</button>
                        <button class="btn btn-outline-secondary" onclick="applyBooking()">Gunakan Saja (Tanpa Simpan)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL EDIT USER -->
    <div class="modal fade" id="modalEditUser" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header bg-dark text-white"><h5 class="modal-title">Edit Hak Akses & Bawahan</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body bg-light"><form id="formEditUser"><input type="hidden" id="editUserEmail"><div class="row g-2 mb-3 bg-white p-3 rounded shadow-sm"><div class="col-md-6"><label class="small fw-bold">Nama</label><input type="text" class="form-control" id="editUserName" readonly></div><div class="col-md-3"><label class="small fw-bold">Role</label><select class="form-select" id="editUserRole"><option value="User">User</option><option value="Admin">Admin</option><option value="Super Admin">Super Admin</option></select></div><div class="col-md-3"><label class="small fw-bold">Status</label><select class="form-select" id="editUserStatus"><option value="Aktif">Aktif</option><option value="Blokir">Blokir</option></select></div></div>
    
    <!-- SETTING BAWAHAN (CHECKBOX LIST) -->
    <div class="mb-3 p-3 bg-white border rounded shadow-sm">
        <label class="fw-bold text-success"><i class="fas fa-sitemap me-2"></i>Pilih Bawahan (Tujuan Disposisi)</label>
        <p class="small text-muted mb-2">Pilih akun pengguna yang akan menjadi bawahan atau tujuan disposisi untuk user ini.</p>
        <div class="input-group mb-2"><span class="input-group-text"><i class="fas fa-search"></i></span><input type="text" class="form-control form-control-sm" id="searchSubs" placeholder="Cari nama..." onkeyup="filterSubs()"></div>
        <div id="listCandidates" class="border rounded p-2" style="max-height: 200px; overflow-y: auto; background:#f9f9f9;"></div>
    </div>

    <div class="bg-white p-3 rounded shadow-sm border" style="max-height: 400px; overflow-y: auto;">
        <div class="perm-category">A. INPUT</div><div class="perm-grid"><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="input_masuk"><label class="form-check-label">Input Masuk</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="input_keluar"><label class="form-check-label">Input Keluar</label></div></div>
        <div class="perm-category">B. INBOX</div><div class="perm-grid"><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="inbox_staf"><label class="form-check-label text-primary">Inboxku (Staf)</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="inbox_direktur"><label class="form-check-label">Inbox Direktur</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="inbox_wadir_adm"><label class="form-check-label">Wadir Adm</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="inbox_wadir_pel"><label class="form-check-label">Wadir Pel</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="inbox_kabag_umum"><label class="form-check-label">Kabag Umum</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="inbox_kabag_keu"><label class="form-check-label">Kabag Keu</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="inbox_kabag_prog"><label class="form-check-label">Kabag Program</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="inbox_kabid_yanmed"><label class="form-check-label">Kabid Yanmed</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="inbox_kabid_penunjang"><label class="form-check-label">Kabid Penunjang</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="inbox_kabid_kep"><label class="form-check-label">Kabid Kep</label></div></div>
        <div class="perm-category">C. ARSIP</div><div class="perm-grid"><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="arsip_masuk_all"><label class="form-check-label fw-bold text-success">SEMUA MASUK</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="arsip_masuk_direktur"><label class="form-check-label">Masuk Direktur</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="arsip_keluar_all"><label class="form-check-label fw-bold text-success">SEMUA KELUAR</label></div></div>
        <div class="perm-category">D. EDIT DATA</div><div class="perm-grid"><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="edit_surat_masuk"><label class="form-check-label text-warning fw-bold">Edit Surat Masuk</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="edit_surat_keluar"><label class="form-check-label text-warning fw-bold">Edit Surat Keluar</label></div></div>
        <div class="perm-category">E. ADMIN</div><div class="perm-grid"><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="setting_user"><label class="form-check-label text-danger">Setting User</label></div></div>
    </div></form></div><div class="modal-footer"><button type="button" class="btn btn-primary" onclick="saveUserPermissions()">Simpan</button></div></div></div></div>

    <!-- MODAL EDIT SURAT MASUK & KELUAR (Standard) -->
    <div class="modal fade" id="modalEditSuratMasuk" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning text-dark"><h5 class="modal-title">Edit Surat Masuk</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="formEditSuratMasuk"><input type="hidden" id="em_noAgenda"><div class="row g-2 mb-3"><div class="col-md-6"><label class="small fw-bold">Agenda</label><input type="text" class="form-control" id="em_displayAgenda" disabled></div><div class="col-md-6"><label class="small fw-bold">No Surat</label><input type="text" class="form-control" id="em_noSurat"></div></div><div class="row g-2 mb-3"><div class="col-md-6"><label class="small fw-bold">Tgl Surat</label><input type="date" class="form-control" id="em_tglSurat"></div><div class="col-md-6"><label class="small fw-bold">Tgl Terima</label><input type="date" class="form-control" id="em_tglTerima"></div></div><div class="mb-3"><label class="small fw-bold">Pengirim</label><input type="text" class="form-control" id="em_pengirim"></div><div class="mb-3"><label class="small fw-bold">Kode Klarifikasi</label><input type="text" class="form-control" id="em_kodeKlarifikasi" list="listKodeKlarifikasi"></div><div class="mb-3"><label class="small fw-bold">Perihal</label><textarea class="form-control" id="em_perihal" rows="3"></textarea></div><div class="mb-3"><label class="small fw-bold">Ganti File (Opsional)</label><input type="file" class="form-control" id="em_file"></div><button type="button" class="btn btn-warning w-100 fw-bold" onclick="saveEditMasuk()">Simpan Perubahan</button></form></div></div></div></div>
    <div class="modal fade" id="modalEditSuratKeluar" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning text-dark"><h5 class="modal-title">Edit Surat Keluar</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="formEditSuratKeluar"><input type="hidden" id="ek_noAgenda"><div class="row g-2 mb-3"><div class="col-md-6"><label class="small fw-bold">Agenda</label><input type="text" class="form-control" id="ek_displayAgenda" disabled></div><div class="col-md-6"><label class="small fw-bold">No Surat</label><input type="text" class="form-control" id="ek_noSurat"></div></div><div class="mb-3"><label class="small fw-bold">Tgl Surat</label><input type="date" class="form-control" id="ek_tglSurat"></div><div class="mb-3"><label class="small fw-bold">Tujuan</label><input type="text" class="form-control" id="ek_tujuan"></div><div class="mb-3"><label class="small fw-bold">Perihal</label><textarea class="form-control" id="ek_perihal" rows="3"></textarea></div><div class="mb-3"><label class="small fw-bold">Ganti File (Opsional)</label><input type="file" class="form-control" id="ek_file"></div><button type="button" class="btn btn-warning w-100 fw-bold" onclick="saveEditKeluar()">Simpan Perubahan</button></form></div></div></div></div>
    <div class="modal fade" id="modalDisposisi" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning text-dark"><h5 class="modal-title">Kirim Disposisi</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="formDisposisi"><input type="hidden" id="dispIdSurat"><div class="alert alert-light border shadow-sm mb-3"><small class="text-muted d-block fw-bold">Perihal:</small><span id="dispPerihal" class="fs-6">...</span></div>
        <div class="mb-3">
            <label class="fw-bold small mb-1">Teruskan Ke (Bisa lebih dari 1):</label>
            <div id="dispTargetContainer" class="border rounded p-2 bg-light" style="max-height: 150px; overflow-y: auto;"></div>
        </div>
        <div class="mb-3"><label class="fw-bold small mb-1">Instruksi:</label><textarea class="form-control" id="dispInstruksi" rows="4"></textarea></div><button type="button" class="btn btn-warning w-100 fw-bold" onclick="submitDisposisi()">Kirim</button>
    </form></div></div></div></div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzuRKsINcUfY9tku6r1K7T-UBNOO054M9iiJdrgoIjqOf3jKfPeuBq1YX9moB9iJIMOvQ/exec"; 
        let currentUserEmail = "", currentInboxLevel = "", currentArsipScope = "";
        let allUsersList = []; 
        
        $(document).ready(function() { 
            if(sessionStorage.getItem('isLoggedIn')==='true'){ currentUserEmail=sessionStorage.getItem('userEmail'); showApp(); renderSidebarPermissions(); loadRefCodes(); } 
            $('#sidebarCollapse').on('click', function(){$('#sidebar, #content').toggleClass('toggled')}); 
            
            // --- UPDATED PARTICLES CONFIG (ICONS) ---
            tsParticles.load("tsparticles", {
                fpsLimit: 60,
                particles: {
                    number: { value: 30, density: { enable: true, value_area: 800 } },
                    color: { value: "#ffffff" },
                    shape: {
                        type: "image",
                        image: [
                            { src: "data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23ffffff' d='M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4L236.8 313.6c11.4 8.5 27 8.5 38.4 0L492.8 150.4c12.1-9.1 19.2-23.3 19.2-38.4c0-26.5-21.5-48-48-48H48zM0 176V384c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V176L294.4 339.2c-22.8 17.1-54 17.1-76.8 0L0 176z'/%3E%3C/svg%3E", width: 32, height: 32 },
                            { src: "data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 384 512'%3E%3Cpath fill='%23ffffff' d='M0 64C0 28.7 28.7 0 64 0H224V128c0 17.7 14.3 32 32 32H384V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V64zm384 64H256V0L384 128z'/%3E%3C/svg%3E", width: 32, height: 32 }
                        ]
                    },
                    opacity: { value: 0.6, random: true },
                    size: { value: 20, random: true },
                    line_linked: { enable: true, distance: 150, color: "#ffffff", opacity: 0.3, width: 1 },
                    move: { enable: true, speed: 2, direction: "none", random: false, straight: false, out_mode: "out", bounce: false }
                },
                interactivity: {
                    detect_on: "canvas",
                    events: { onhover: { enable: true, mode: "grab" }, onclick: { enable: true, mode: "push" }, resize: true },
                    modes: { grab: { distance: 200, line_linked: { opacity: 0.5 } }, push: { particles_nb: 4 } }
                },
                retina_detect: true
            });
        });

        function showLoading(s){$('#loadingOverlay').css('display',s?'flex':'none')}
        
        function showApp(){
            $('#tsparticles').addClass('in-background');
            $('#loginSection').fadeOut(500, function() {
                $('#door-overlay').addClass('door-open');
                setTimeout(() => {
                    $('#appContent').fadeIn(500);
                    $('#userDisplayName').text(sessionStorage.getItem('userName'));
                    $('#userRoleBadge').text(sessionStorage.getItem('userRole'));
                    $('#homeDisplayName').text(sessionStorage.getItem('userName'));
                    $('#homeRoleBadge').text(sessionStorage.getItem('userRole'));
                    if($('#btn-home').length) { $('#btn-home').click(); }
                }, 300);
            });
        }
        
        function activateTab(t,e,cb){$('.nav-link').removeClass('active');if(e)$(e).addClass('active');$('.tab-pane').removeClass('active');$('#'+t).addClass('active');if(cb)cb()}
        function logout(){sessionStorage.clear();location.reload()}
        function handleCredentialResponse(r){showLoading(true);fetch(GAS_URL,{method:'POST',body:JSON.stringify({type:'google_login',credential:r.credential})}).then(res=>res.json()).then(res=>{showLoading(false);if(res.status==='success'){sessionStorage.setItem('isLoggedIn','true');sessionStorage.setItem('userEmail',res.data.email);sessionStorage.setItem('userRole',res.data.role);sessionStorage.setItem('userPermissions',JSON.stringify(res.data.permissions));sessionStorage.setItem('userSubordinates',JSON.stringify(res.data.subordinates));sessionStorage.setItem('userName',res.data.name);currentUserEmail=res.data.email;showApp();renderSidebarPermissions();loadRefCodes();}else{Swal.fire('Login Gagal',res.message,'error')}}).catch(e=>{showLoading(false);Swal.fire('Error','Koneksi','error')})}
        function renderSidebarPermissions(){const r=sessionStorage.getItem('userRole');const p=JSON.parse(sessionStorage.getItem('userPermissions')||"[]");$('.restricted-feature').addClass('restricted-feature');if(r==='Super Admin'){$('.restricted-feature').removeClass('restricted-feature')}else{p.forEach(x=>$(`[data-perm="${x}"]`).removeClass('restricted-feature'));if(r==='User')$(`[data-perm="inbox_staf"]`).removeClass('restricted-feature')}}
        function openDisposisiPage(l,e){currentInboxLevel=l;$('#dispPageTitle').text(l.replace(/_/g,' ').toUpperCase());activateTab('disposisi-container',e,refreshCurrentDisposisi)}
        function refreshCurrentDisposisi(){showLoading(true);fetch(`${GAS_URL}?action=read_inbox&level=${currentInboxLevel}&email=${currentUserEmail}`).then(r=>r.json()).then(r=>{showLoading(false);const dt=$('#tableDisposisi').DataTable({destroy:true,language:{url:"//cdn.datatables.net/plug-ins/1.13.4/i18n/id.json"}});dt.clear();if(r.data)r.data.forEach(d=>dt.row.add([d.tgl,d.agenda,d.pengirim,d.perihal,`<button class="btn btn-sm btn-warning" onclick="openDisposisiModal('${d.id}','${d.perihal}')">Proses</button>`]));dt.draw()})}
        
        // --- NEW DISPOSISI MODAL LOGIC (CHECKBOXES) ---
        function openDisposisiModal(id, p) {
            $('#dispIdSurat').val(id);
            $('#dispPerihal').text(p);
            $('#dispInstruksi').val('');
            
            const container = $('#dispTargetContainer');
            container.empty();
            
            const subs = JSON.parse(sessionStorage.getItem('userSubordinates') || "[]");
            let t = [];

            // Mapping Logic
            if (currentInboxLevel === 'direktur') t = ['Wadir Administrasi & Keuangan', 'Wadir Pelayanan'];
            else if (currentInboxLevel === 'wadir_adm') t = ['Kabag Administrasi & Umum', 'Kabag Keuangan', 'Kabag Program & Pelaporan'];
            else if (currentInboxLevel === 'wadir_pel') t = ['Kabid Pelayanan Medik', 'Kabid Pelayanan Penunjang', 'Kabid Pelayanan Keperawatan'];
            else if (currentInboxLevel.includes('kabag') || currentInboxLevel.includes('kabid')) t = subs;
            
            // Fallback
            if (t.length === 0 && subs.length > 0) t = subs; 

            if (t.length === 0) {
                container.html('<span class="text-muted small">Tidak ada tujuan tersedia. Hubungi Admin.</span>');
            } else {
                t.forEach(x => {
                    container.append(`
                        <div class="form-check">
                            <input class="form-check-input target-check" type="checkbox" value="${x}" id="chk_${x.replace(/\s/g,'')}">
                            <label class="form-check-label small" for="chk_${x.replace(/\s/g,'')}">${x}</label>
                        </div>
                    `);
                });
            }

            new bootstrap.Modal(document.getElementById('modalDisposisi')).show();
        }

        function submitDisposisi() {
            const selected = [];
            $('.target-check:checked').each(function() { selected.push($(this).val()); });

            if (selected.length === 0) return Swal.fire('!', 'Pilih minimal satu tujuan', 'warning');
            
            const p = {
                type: 'submit_disposisi',
                idSurat: $('#dispIdSurat').val(),
                levelAsal: currentInboxLevel,
                target: selected.join(', '), 
                instruksi: $('#dispInstruksi').val(),
                sender: currentUserEmail
            };
            
            bootstrap.Modal.getInstance(document.getElementById('modalDisposisi')).hide();
            showLoading(true);
            fetch(GAS_URL, { method: 'POST', body: JSON.stringify(p) }).then(r => r.json()).then(r => {
                showLoading(false);
                if (r.status === 'success') { Swal.fire('OK', 'Terkirim', 'success'); refreshCurrentDisposisi(); }
                else Swal.fire('Err', r.message, 'error');
            });
        }

        function openAdvancedSearch(){ new bootstrap.Modal(document.getElementById('modalSearchAdvanced')).show(); }
        function submitSearchAdvanced(){
            const d = {
                type: 'search_advanced',
                category: $('#sa_category').val(),
                keyword: $('#sa_keyword').val(),
                startDate: $('#sa_start').val(),
                endDate: $('#sa_end').val()
            };
            bootstrap.Modal.getInstance(document.getElementById('modalSearchAdvanced')).hide();
            showLoading(true);
            fetch(GAS_URL, {method:'POST', body:JSON.stringify(d)}).then(r=>r.json()).then(r=>{
                showLoading(false);
                if(r.status==='success'){
                    activateTab('search-content', null);
                    const dt=$('#tableSearch').DataTable({destroy:true}); dt.clear();
                    r.data.results.forEach(d=>{
                        let link = d.file ? `<a href="${d.file}" target="_blank">File</a>` : '-';
                        dt.row.add([d.tgl, d.agenda, d.ref, d.perihal, d.ocr, link]);
                    });
                    dt.draw();
                } else Swal.fire('Err', r.message, 'error');
            });
        }

        function openArsipPage(t,s,e){currentArsipScope=s;if(t==='masuk')activateTab('arsip-masuk-container',e,loadArsipMasuk);else activateTab('arsip-keluar-container',e,loadArsipKeluar)}
        function loadArsipMasuk(){showLoading(true);fetch(`${GAS_URL}?action=read_arsip_masuk&scope=${currentArsipScope}`).then(r=>r.json()).then(r=>{showLoading(false);const dt=$('#tableArsipMasuk').DataTable({destroy:true, order:[[1,'desc']]}); dt.clear();const canEdit = sessionStorage.getItem('userRole')==='Super Admin' || JSON.parse(sessionStorage.getItem('userPermissions')||"[]").includes('edit_surat_masuk');if(r.data) r.data.forEach(d=>{let btnEdit = canEdit ? `<button class="btn btn-sm btn-warning ms-1" onclick='openEditMasuk(${JSON.stringify(d)})'><i class="fas fa-pencil-alt"></i></button>` : '';dt.row.add([d.tglTerima,d.agenda,d.pengirim,d.perihal,d.status,d.file?`<a href="${d.file}" target="_blank">File</a>`:'-', d.kode||'-', btnEdit]);});dt.draw();});}
        function loadArsipKeluar(){showLoading(true);fetch(`${GAS_URL}?action=read_arsip_keluar&scope=${currentArsipScope}`).then(r=>r.json()).then(r=>{showLoading(false);const dt=$('#tableArsipKeluar').DataTable({destroy:true, order:[[0,'desc']]}); dt.clear();const canEdit = sessionStorage.getItem('userRole')==='Super Admin' || JSON.parse(sessionStorage.getItem('userPermissions')||"[]").includes('edit_surat_keluar');if(r.data) r.data.forEach(d=>{let btnEdit = canEdit ? `<button class="btn btn-sm btn-warning ms-1" onclick='openEditKeluar(${JSON.stringify(d)})'><i class="fas fa-pencil-alt"></i></button>` : '';dt.row.add([d.agenda,d.tglSurat,d.tujuan,d.perihal,d.status,d.file?`<a href="${d.file}" target="_blank">File</a>`:'-', btnEdit]);});dt.draw();});}
        function loadRefCodes() {fetch(`${GAS_URL}?action=get_ref_codes`).then(r => r.json()).then(r => {if (r.status === 'success' && r.data) {const list = $('#listKodeKlarifikasi');list.empty();r.data.forEach(item => {list.append(`<option value="${item.code}">${item.desc}</option>`);});}});}
        function openEditMasuk(row){ $('#em_noAgenda').val(row.agenda); $('#em_displayAgenda').val(row.agenda); $('#em_noSurat').val(row.noSurat); $('#em_tglSurat').val(formatDateInput(row.tglSurat)); $('#em_tglTerima').val(formatDateInput(row.tglTerima)); $('#em_pengirim').val(row.pengirim); $('#em_perihal').val(row.perihal); $('#em_kodeKlarifikasi').val(row.kode); $('#em_file').val(''); new bootstrap.Modal(document.getElementById('modalEditSuratMasuk')).show(); }
        function openEditKeluar(row){ $('#ek_noAgenda').val(row.agenda); $('#ek_displayAgenda').val(row.agenda); $('#ek_noSurat').val(row.noSurat); $('#ek_tglSurat').val(formatDateInput(row.tglSurat)); $('#ek_tujuan').val(row.tujuan); $('#ek_perihal').val(row.perihal); $('#ek_file').val(''); new bootstrap.Modal(document.getElementById('modalEditSuratKeluar')).show(); }
        async function saveEditMasuk(){const f = $('#em_file')[0].files[0]; let fData="",fName="";if(f){fData=await readFile(f);fName=f.name;}const d = { type:'edit_surat_masuk', email:currentUserEmail, noAgenda:$('#em_noAgenda').val(), noSurat:$('#em_noSurat').val(), tglSurat:$('#em_tglSurat').val(), tglTerima:$('#em_tglTerima').val(), pengirim:$('#em_pengirim').val(), perihal:$('#em_perihal').val(), kodeKlarifikasi:$('#em_kodeKlarifikasi').val(), fileData:fData, fileName:fName };bootstrap.Modal.getInstance(document.getElementById('modalEditSuratMasuk')).hide();sendData(d, ()=>{Swal.fire('OK','Data Diupdate','success'); loadArsipMasuk();});}
        async function saveEditKeluar(){const f = $('#ek_file')[0].files[0]; let fData="",fName="";if(f){fData=await readFile(f);fName=f.name;}const d = { type:'edit_surat_keluar', email:currentUserEmail, noAgenda:$('#ek_noAgenda').val(), noSurat:$('#ek_noSurat').val(), tglSurat:$('#ek_tglSurat').val(), tujuan:$('#ek_tujuan').val(), perihal:$('#ek_perihal').val(), fileData:fData, fileName:fName };bootstrap.Modal.getInstance(document.getElementById('modalEditSuratKeluar')).hide();sendData(d, ()=>{Swal.fire('OK','Data Diupdate','success'); loadArsipKeluar();});}
        function formatDateInput(dStr){ if(!dStr || dStr==='-') return ''; const parts=dStr.split('/'); if(parts.length===3) return `${parts[2]}-${parts[1]}-${parts[0]}`; return ''; }
        function loadUsers(){showLoading(true);fetch(`${GAS_URL}?type=get_users_list`,{method:'POST',body:JSON.stringify({type:'get_users_list',requestor:currentUserEmail})}).then(r=>r.json()).then(r=>{showLoading(false);allUsersList = r.data || []; const dt=$('#tableUsers').DataTable({destroy:true});dt.clear();if(r.data)r.data.forEach(u=>dt.row.add([u.email,u.name,u.role,u.status,`<button class="btn btn-sm btn-info" onclick='openEditUser(${JSON.stringify(u)})'>Edit</button>`]));dt.draw()});}
        
        function openEditUser(u){
            $('#editUserEmail').val(u.email); $('#editUserName').val(u.name); $('#editUserRole').val(u.role); $('#editUserStatus').val(u.status);
            $('.perm-check').prop('checked',false); try{ JSON.parse(u.permissions).forEach(x=>$(`input[value="${x}"]`).prop('checked',true)) } catch(e){}
            const listDiv = $('#listCandidates'); listDiv.empty();
            const currentSubs = JSON.parse(u.subordinates || "[]");
            allUsersList.forEach(user => {
                if(user.email !== u.email) {
                    const isChecked = currentSubs.includes(user.name) ? 'checked' : '';
                    listDiv.append(`<div class="user-list-item"><input class="form-check-input me-2 sub-check" type="checkbox" value="${user.name}" ${isChecked}><div><div class="fw-bold small">${user.name}</div><div class="text-muted" style="font-size:0.75rem">${user.email}</div></div></div>`);
                }
            });
            new bootstrap.Modal(document.getElementById('modalEditUser')).show();
        }
        function filterSubs() { const term = $('#searchSubs').val().toLowerCase(); $('.user-list-item').each(function() { const text = $(this).text().toLowerCase(); $(this).toggle(text.includes(term)); }); }
        function saveUserPermissions(){const p=[];$('.perm-check:checked').each(function(){p.push($(this).val())});const subsList = [];$('.sub-check:checked').each(function(){ subsList.push($(this).val()); });const d={type:'update_user_permissions',requestor:currentUserEmail,targetEmail:$('#editUserEmail').val(),role:$('#editUserRole').val(),status:$('#editUserStatus').val(),permissions:JSON.stringify(p),subordinates: JSON.stringify(subsList)};bootstrap.Modal.getInstance(document.getElementById('modalEditUser')).hide();showLoading(true);fetch(GAS_URL,{method:'POST',body:JSON.stringify(d)}).then(r=>r.json()).then(r=>{showLoading(false);if(r.status==='success'){Swal.fire('OK','Tersimpan','success');loadUsers()}else Swal.fire('Err',r.message,'error')});}
        
        function loadStorageStats(){showLoading(true);fetch(`${GAS_URL}?action=get_storage_stats&requestor=${currentUserEmail}`).then(r=>r.json()).then(r=>{showLoading(false);if(r.status==='success'){const d=r.data;$('#disp-quota-A').text(d.nodeA.percentage+'%');$('#prog-A').css('width',d.nodeA.percentage+'%');$('#disp-quota-B').text(d.nodeB.percentage+'%');$('#prog-B').css('width',d.nodeB.percentage+'%');$('#disp-quota-C').text(d.nodeC.percentage+'%');$('#prog-C').css('width',d.nodeC.percentage+'%');$('#switchFailover').prop('checked',d.settings.failover);$('#selectActiveNode').val(d.settings.activeNode)}else Swal.fire('Akses Ditolak','Hanya Admin','warning')})}
        function saveStorageSettings(){const f=$('#switchFailover').is(':checked');const a=$('#selectActiveNode').val();showLoading(true);fetch(GAS_URL,{method:'POST',body:JSON.stringify({type:'update_storage_settings',failover:f,activeNode:a,requestor:currentUserEmail})}).then(r=>r.json()).then(r=>{showLoading(false);if(r.status==='success')Swal.fire('OK','Disimpan','success');else Swal.fire('Err',r.message,'error')})}
        function openSettingsPage(e){activateTab('settings-content',e,()=>{loadUsers();if(sessionStorage.getItem('userRole')!=='User')loadStorageStats()})}
        
        // --- INPUT & BOOKING LOGIC ---

        // VALIDATION ON SUBMIT MASUK
        $('#formSuratMasuk').on('submit',async function(e){
            e.preventDefault();
            
            // Validate Date Logic
            const tglS = new Date($('input[name="tglSurat"]').val());
            const tglT = new Date($('input[name="tglTerima"]').val());
            if(tglS > tglT) {
                return Swal.fire('Error Tanggal', 'Tanggal Surat tidak boleh lebih baru dari Tanggal Terima.', 'warning');
            }

            showLoading(true);
            let f="",n="";
            const fi=$('#fileSuratMasuk')[0].files[0];
            if(fi){f=await readFile(fi);n=fi.name}
            const d={type:'simpan_masuk',fileData:f,fileName:n,email:currentUserEmail};
            $(this).serializeArray().forEach(x=>d[x.name]=x.value);
            sendData(d,()=> {
                Swal.fire('OK','Masuk Tersimpan','success');
                autoFillAgendaMasuk(); // Refresh Agenda number for next input
            });
        });

        // VALIDATION ON SUBMIT KELUAR
        $('#formSuratKeluar').on('submit',async function(e){
            e.preventDefault();
            showLoading(true);
            let f="",n="";
            const fi=$('#fileSuratKeluar')[0].files[0];
            if(fi){f=await readFile(fi);n=fi.name}
            const d={type:'simpan_keluar',fileData:f,fileName:n,email:currentUserEmail};
            $(this).serializeArray().forEach(x=>d[x.name]=x.value);
            sendData(d,()=> {
                Swal.fire('OK','Keluar Tersimpan','success');
                autoFillAgendaKeluar(); // Refresh Agenda number for next input
            });
        });

        function sendData(d,cb){fetch(GAS_URL,{method:'POST',body:JSON.stringify(d)}).then(r=>r.json()).then(r=>{showLoading(false);if(r.status==='success'){cb();$('form').trigger('reset'); setDefaultDatesMasuk(); }else Swal.fire('Err',r.message,'error')})}
        function readFile(f){return new Promise((r,j)=>{const fr=new FileReader();fr.readAsDataURL(f);fr.onload=()=>r(fr.result);fr.onerror=e=>j(e)})}
        
        // --- AUTO FILL LOGIC ---
        function autoFillAgendaMasuk() {
            $('#inNoAgenda').val('Loading...');
            fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ type: 'get_last_agenda_masuk' }) })
            .then(r => r.json())
            .then(r => {
                if (r.status === 'success') $('#inNoAgenda').val(r.data.nextAgenda);
            });
        }

        function autoFillAgendaKeluar() {
            $('#outNoAgenda').val('Loading...');
            fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ type: 'get_last_agenda_keluar' }) })
            .then(r => r.json())
            .then(r => {
                if (r.status === 'success') $('#outNoAgenda').val(r.data.nextAgenda);
            });
        }

        function openBookingModal(category) {
            $('#bookingCategory').val(category);
            $('#modalBooking .modal-title').text(category === 'keluar' ? 'Booking Agenda Keluar' : 'Booking Agenda Masuk');
            
            new bootstrap.Modal(document.getElementById('modalBooking')).show();
            $('#lastAgendaDisplay').text('Loading...');
            $('#bookingValue').val('');
            
            // Determine which last agenda to fetch
            const reqType = category === 'keluar' ? 'get_last_agenda_keluar' : 'get_last_agenda_masuk';
            
            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ type: reqType })
            })
            .then(r => r.json())
            .then(r => {
                if (r.status === 'success') {
                    const last = r.data.lastAgenda > 0 ? r.data.lastAgenda : '-';
                    $('#lastAgendaDisplay').text(last);
                    $('#bookingValue').val(r.data.nextAgenda);
                } else {
                    $('#lastAgendaDisplay').text('Error');
                }
            });
        }

        function applyBooking() {
            const val = $('#bookingValue').val();
            const cat = $('#bookingCategory').val();
            if(val) {
                if(cat === 'keluar') $('#outNoAgenda').val(val);
                else $('#inNoAgenda').val(val);
                bootstrap.Modal.getInstance(document.getElementById('modalBooking')).hide();
            }
        }

        function saveBooking() {
            const val = $('#bookingValue').val();
            const cat = $('#bookingCategory').val();
            const note = $('#bookingNote').val();
            if(!val) return Swal.fire('Warning', 'Isi Nomor Agenda', 'warning');
            
            bootstrap.Modal.getInstance(document.getElementById('modalBooking')).hide();
            showLoading(true);
            
            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({
                    type: 'booking_agenda',
                    category: cat,
                    targetAgenda: val,
                    email: currentUserEmail,
                    note: note
                })
            })
            .then(r => r.json())
            .then(r => {
                showLoading(false);
                if(r.status === 'success') {
                    Swal.fire('Sukses', r.data.message, 'success');
                    // Refresh input field if currently on that page
                    if(cat === 'keluar') autoFillAgendaKeluar();
                    else autoFillAgendaMasuk();
                } else {
                    Swal.fire('Gagal', r.message, 'error');
                }
            });
        }

        function setDefaultDatesMasuk() {
            const today = new Date().toISOString().split('T')[0];
            if(!$('input[name="tglSurat"]').val()) $('input[name="tglSurat"]').val(today);
            if(!$('input[name="tglTerima"]').val()) $('input[name="tglTerima"]').val(today);
        }
    </script>
</body>
</html>
