<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMAS KOESMA - RSUD dr. R. Koesma</title>
    <link rel="icon" href="https://github.com/koesmasurat/simas/blob/main/logo%20rsud%202%20png.png?raw=true" type="image/png">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- SheetJS, JSZip, FileSaver for Manual Backup Feature -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        /* ... existing styles ... */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --text-light: #f8f9fa;
            --emerald-accent: #f97316; 
            --blue-accent: #3b82f6;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #9a3412 0%, #0f172a 100%);
            background-attachment: fixed;
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .glass-panel, .card, .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            color: white;
        }
        
        .card { margin-bottom: 25px; border-radius: 16px; transition: transform 0.2s; }
        .modal-content { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }

        #loginSection { height: 100vh; display: flex; justify-content: center; align-items: center; position: relative; z-index: 10; }
        .login-card { width: 100%; max-width: 400px; padding: 2.5rem; text-align: center; }
        .form-control, .form-select { background: #fff; border: 1px solid #ced4da; color: #333; }
        .btn-primary { background: linear-gradient(45deg, var(--emerald-accent), var(--blue-accent)); border: none; padding: 12px; border-radius: 8px; font-weight: 600; transition: all 0.3s ease; }
        
        #appContent { display: none; width: 100%; min-height: 100vh; }
        .wrapper { display: flex; width: 100%; align-items: stretch; transition: all 0.3s; }
        
        #sidebar {
            min-width: var(--sidebar-width); max-width: var(--sidebar-width); 
            background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(15px); 
            border-right: 1px solid var(--glass-border); color: #fff; 
            transition: all 0.3s; position: fixed; height: 100vh; z-index: 1000; margin-left: 0;
            display: flex; flex-direction: column;
        }
        #sidebar.toggled { margin-left: calc(var(--sidebar-width) * -1); }
        .sidebar-menu-scroll { flex-grow: 1; overflow-y: auto; overflow-x: hidden; padding: 1rem; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.2) transparent; }
        .sidebar-footer { padding: 1rem; flex-shrink: 0; background: rgba(0,0,0,0.1); }

        #content { width: 100%; padding: 20px; margin-left: var(--sidebar-width); transition: all 0.3s; }
        #content.toggled { margin-left: 0; }

        #sidebarCollapse { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 10px 15px; border-radius: 8px; cursor: pointer; margin-bottom: 20px; transition: all 0.3s; }
        
        #arsip-masuk-content .card, #arsip-keluar-content .card, #disposisi-container .card, #settings-content .card, #log-content .card { background: #ffffff !important; backdrop-filter: none; color: #333333; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .card-header { background-color: #fff7ed; border-bottom: 2px solid #ffedd5; color: #c2410c; }
        #disposisi-container .card-header { background-color: #fffbeb; border-bottom: 2px solid #fcd34d; color: #b45309; }
        
        .table { color: #333 !important; font-size: 0.9rem; }
        .table th { background-color: #e9ecef; color: #495057; padding: 8px; font-weight: 600; }
        .table td { padding: 4px 8px; vertical-align: middle; border-color: #dee2e6; }
        .table-striped > tbody > tr:nth-of-type(odd) > * { background-color: rgba(255, 237, 213, 0.3) !important; color: #333 !important; }
        
        .page-link { background: white; color: #c2410c; border: 1px solid #fed7aa; }
        .page-item.active .page-link { background: #f97316; color: white; border-color: #f97316; }
        
        .nav-pills .nav-link { color: rgba(255, 255, 255, 0.7); border-radius: 10px; padding: 12px 20px; margin-bottom: 8px; text-align: left; display: flex; align-items: center; cursor: pointer; transition: all 0.2s ease-in-out; }
        .nav-pills .nav-link:hover { background: rgba(255, 255, 255, 0.1); color: #fff; transform: translateX(5px); }
        .nav-pills .nav-link.active { background: linear-gradient(90deg, var(--emerald-accent), transparent); color: #fff; border-left: 4px solid #fff; }
        .nav-link i { width: 25px; margin-right: 10px; }
        .submenu { padding-left: 20px; background: rgba(0,0,0,0.2); border-radius: 10px; margin-bottom: 10px; }
        .submenu .nav-link { font-size: 0.9em; padding: 8px 15px; border-left: none !important; }
        .submenu .nav-link.active { background: rgba(255,255,255,0.1); color: var(--emerald-accent); font-weight: bold; transform: none; }
        
        .badge-count { font-size: 0.75rem; padding: 4px 8px; border-radius: 12px; margin-left: auto; background: var(--blue-accent); color: white; display: none; }
        .badge-count.has-data { display: inline-block; background: #ef4444; }

        .tab-pane { transition: opacity 0.3s ease-in-out; opacity: 0; display: none; }
        .tab-pane.active { display: block; }
        .tab-pane.show { opacity: 1; }
        .timeline-item { padding-left: 30px; border-left: 2px solid rgba(255,255,255,0.2); position: relative; padding-bottom: 20px; }
        .timeline-item::before { content: ''; position: absolute; left: -9px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: var(--blue-accent); border: 2px solid #fff; }
        .timeline-item.done::before { background: var(--emerald-accent); }
        .timeline-content { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); }

        @media (max-width: 991.98px) {
            #sidebar { margin-left: calc(var(--sidebar-width) * -1); }
            #sidebar.toggled { margin-left: 0; }
            #content { margin-left: 0; }
        }

        #loadingOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000; display: none; justify-content: center; align-items: center; flex-direction: column; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(5px); }
        .restricted-feature { display: none !important; }
    </style>
</head>
<body>

    <div id="loginSection">
        <div class="glass-panel login-card">
            <div class="mb-4">
                <img src="https://github.com/koesmasurat/simas/blob/main/logo%20rsud%202%20png.png?raw=true" alt="Logo RSUD" style="width: 100px; height: auto;" class="mb-3">
                <h3 class="fw-bold">SIMAS KOESMA</h3>
                <p class="text-white-50">Sistem Informasi Manajemen Arsip Surat<br>RSUD dr. R. Koesma</p>
            </div>
            
            <div class="d-flex justify-content-center mt-4">
                <div id="g_id_onload"
                     data-client_id="783459415718-mp0vsmd2lopajf2ut0aqc6drjrs95pu8.apps.googleusercontent.com"
                     data-callback="handleCredentialResponse"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin" data-type="standard" data-size="large" data-theme="filled_blue" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
            </div>
            <p class="mt-3 small text-white-50">Silakan login menggunakan akun Google Anda.</p>
        </div>
    </div>

    <div id="appContent">
        <div class="wrapper">
            <nav id="sidebar">
                <div class="sidebar-header text-center position-relative">
                    <button type="button" id="sidebarCloseMobile" class="btn btn-sm btn-outline-light d-lg-none position-absolute top-0 end-0 m-2"><i class="fas fa-times"></i></button>
                    <img src="https://github.com/koesmasurat/simas/blob/main/logo%20rsud%202%20png.png?raw=true" alt="Logo" class="mb-2" style="width: 60px; height: auto;">
                    <h5 class="fw-bold m-0">SIMAS KOESMA</h5>
                    <small class="text-white-50 d-block" id="userDisplayName">User</small>
                    <span class="badge bg-info text-dark" id="userRoleBadge">Role</span>
                </div>
                
                <div class="sidebar-menu-scroll">
                    <div class="nav flex-column nav-pills">
                        <button class="nav-link active restricted-feature" data-perm="input_masuk" id="btn-input-masuk" onclick="activateTab('input-masuk-content', this)"><i class="fas fa-plus-circle"></i> Surat Masuk</button>
                        <button class="nav-link restricted-feature" data-perm="input_keluar" id="btn-input-keluar" onclick="activateTab('input-keluar-content', this)"><i class="fas fa-paper-plane"></i> Surat Keluar</button>

                        <div class="sidebar-divider"></div>

                        <a class="nav-link text-warning" data-bs-toggle="collapse" href="#submenuDisposisi" role="button" aria-expanded="false">
                            <i class="fas fa-tasks"></i> Menu Disposisi <i class="fas fa-chevron-down ms-auto small"></i>
                        </a>
                        <div class="collapse submenu" id="submenuDisposisi">
                            <button class="nav-link w-100 d-flex justify-content-between restricted-feature" data-perm="disp_direktur" id="btn-disp-direktur" onclick="openDisposisiPage('direktur', this)"><span>1. Direktur</span> <span class="badge-count" id="count-direktur">0</span></button>
                            <button class="nav-link w-100 d-flex justify-content-between restricted-feature" data-perm="disp_wadir_admin" id="btn-disp-wadir-admin" onclick="openDisposisiPage('wadir_admin', this)"><span style="font-size:0.85em">2a. Wadir Adm</span> <span class="badge-count" id="count-wadir_admin">0</span></button>
                            <button class="nav-link w-100 d-flex justify-content-between restricted-feature" data-perm="disp_wadir_pelayanan" id="btn-disp-wadir-pelayanan" onclick="openDisposisiPage('wadir_pelayanan', this)"><span style="font-size:0.85em">2b. Wadir Pel</span> <span class="badge-count" id="count-wadir_pelayanan">0</span></button>
                            
                            <button class="nav-link w-100 d-flex justify-content-between restricted-feature" data-perm="disp_kabag_umum" id="btn-disp-kabag-umum" onclick="openDisposisiPage('kabag_umum', this)"><span style="font-size:0.85em">3a. Kabag Umum</span> <span class="badge-count" id="count-kabag_umum">0</span></button>
                            <button class="nav-link w-100 d-flex justify-content-between restricted-feature" data-perm="disp_kabag_keuangan" id="btn-disp-kabag-keuangan" onclick="openDisposisiPage('kabag_keuangan', this)"><span style="font-size:0.85em">3b. Kabag Keu</span> <span class="badge-count" id="count-kabag_keuangan">0</span></button>
                            <button class="nav-link w-100 d-flex justify-content-between restricted-feature" data-perm="disp_kabag_progpel" id="btn-disp-kabag-progpel" onclick="openDisposisiPage('kabag_progpel', this)"><span style="font-size:0.85em">3c. Kabag Prog</span> <span class="badge-count" id="count-kabag_progpel">0</span></button>
                            <button class="nav-link w-100 d-flex justify-content-between restricted-feature" data-perm="disp_kabid_yanmed" id="btn-disp-kabid-yanmed" onclick="openDisposisiPage('kabid_yanmed', this)"><span style="font-size:0.85em">3d. Kabid Yanmed</span> <span class="badge-count" id="count-kabid_yanmed">0</span></button>
                            <button class="nav-link w-100 d-flex justify-content-between restricted-feature" data-perm="disp_kabid_keperawatan" id="btn-disp-kabid-kep" onclick="openDisposisiPage('kabid_keperawatan', this)"><span style="font-size:0.85em">3e. Kabid Kep</span> <span class="badge-count" id="count-kabid_keperawatan">0</span></button>
                            <button class="nav-link w-100 d-flex justify-content-between restricted-feature" data-perm="disp_kabid_penunjang" id="btn-disp-kabid-penunjang" onclick="openDisposisiPage('kabid_penunjang', this)"><span style="font-size:0.85em">3f. Kabid Penunj</span> <span class="badge-count" id="count-kabid_penunjang">0</span></button>
                            
                            <button class="nav-link w-100 d-flex justify-content-between restricted-feature" data-perm="disp_jf" id="btn-disp-jf" onclick="openDisposisiPage('jf', this)"><span>4. JF (Final)</span> <span class="badge-count" id="count-jf">0</span></button>
                        </div>

                        <div class="sidebar-divider"></div>
                        <button class="nav-link restricted-feature" data-perm="arsip_masuk" id="btn-arsip-masuk" onclick="activateTab('arsip-masuk-content', this, loadDataMasuk)"><i class="fas fa-inbox"></i> Arsip Masuk</button>
                        <button class="nav-link restricted-feature" data-perm="arsip_keluar" id="btn-arsip-keluar" onclick="activateTab('arsip-keluar-content', this, loadDataKeluar)"><i class="fas fa-archive"></i> Arsip Keluar</button>
                        
                        <!-- BACKUP BUTTON -->
                        <button class="nav-link restricted-feature text-warning mt-2" data-perm="backup_data" id="btn-backup" onclick="downloadBackup()"><i class="fas fa-download"></i> Backup Data</button>
                        <!-- AUTO-BACKUP ACTIVATION BUTTON -->
                        <button class="nav-link restricted-feature text-info btn-sm" style="font-size:0.8rem; margin-left:15px; margin-top:-5px;" data-perm="backup_data" id="btn-auto-backup" onclick="activateAutoBackup()"><i class="fas fa-robot"></i> Aktifkan Email Harian</button>
                        
                        <!-- NEW: ACTIVITY LOG BUTTON -->
                        <button class="nav-link restricted-feature text-danger mt-2" id="btn-log" onclick="activateTab('log-content', this, loadLogs)"><i class="fas fa-history"></i> Log Aktivitas</button>

                        <div class="sidebar-divider"></div>
                        <button class="nav-link text-info restricted-feature" data-perm="settings_admin" id="btn-settings" onclick="openSettingsPage(this)"><i class="fas fa-cogs"></i> Pengaturan Pengguna</button>
                    </div>
                </div>

                <div class="sidebar-footer"><button class="btn btn-danger w-100 btn-sm" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Keluar</button></div>
            </nav>

            <div id="content">
                <button type="button" id="sidebarCollapse" class="btn"><i class="fas fa-bars"></i></button>

                <div class="tab-content">
                    
                    <!-- INPUTS (Same) -->
                    <div class="tab-pane active show" id="input-masuk-content"><div class="form-container-limit"><h2 class="mb-4 fw-light text-white">Catat <b class="text-info">Surat Masuk</b></h2><div class="card"><div class="card-body p-4"><form id="formSuratMasuk"><div class="row"><div class="col-md-4 mb-3"><label class="small text-white-50">No. Agenda (Auto)</label><input type="text" class="form-control" name="noAgenda" required></div><div class="col-md-4 mb-3"><label class="small text-white-50">Tanggal Surat</label><input type="date" class="form-control" name="tglSurat" required></div><div class="col-md-4 mb-3"><label class="small text-white-50">Tanggal Terima</label><input type="date" class="form-control" name="tglTerima" required></div></div><div class="mb-3"><label class="small text-white-50">No. Surat</label><input type="text" class="form-control" name="noSurat" required></div><div class="mb-3"><label class="small text-white-50">Pengirim</label><input type="text" class="form-control" name="pengirim" required></div><div class="mb-3"><label class="small text-white-50">Kode Klarifikasi</label><input class="form-control" list="listKodeKlarifikasi" name="kodeKlarifikasi" placeholder="Ketik kode atau keterangan..."><datalist id="listKodeKlarifikasi"></datalist></div><div class="mb-3"><label class="small text-white-50">Perihal</label><textarea class="form-control" name="perihal" rows="3" required></textarea></div><div class="mb-4"><label class="small text-white-50">File (PDF/Img)</label><input type="file" class="form-control" id="fileSuratMasuk"></div><div class="d-grid"><button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Simpan</button></div></form></div></div></div></div>
                    <div class="tab-pane" id="input-keluar-content"><div class="form-container-limit"><h2 class="mb-4 fw-light text-white">Catat <b class="text-success">Surat Keluar</b></h2><div class="card"><div class="card-body p-4"><form id="formSuratKeluar"><div class="row"><div class="col-md-6 mb-3"><label class="small text-white-50">No. Agenda (Auto)</label><div class="input-group"><input type="text" class="form-control" name="noAgenda" id="outNoAgenda" required><button class="btn btn-warning" type="button" onclick="openBookingModal()">Booking No.</button></div></div><div class="col-md-6 mb-3"><label class="small text-white-50">Tanggal Surat Diterima</label><input type="date" class="form-control" name="tglSurat" required></div></div><div class="mb-3"><label class="small text-white-50">No. Surat (Format Dinas)</label><input type="text" class="form-control" name="noSurat" required placeholder="Contoh: 445/001/405.08/2024"></div><div class="mb-3"><label class="small text-white-50">Tujuan</label><input type="text" class="form-control" name="tujuan" required></div><div class="mb-3"><label class="small text-white-50">Perihal</label><textarea class="form-control" name="perihal" rows="3" required></textarea></div><div class="mb-3"><label class="small text-white-50">Pembuat</label><input type="text" class="form-control" name="pembuat"></div><div class="mb-4"><label class="small text-white-50">File</label><input type="file" class="form-control" id="fileSuratKeluar"></div><div class="d-grid"><button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Simpan</button></div></form></div></div></div></div>

                    <!-- DISPOSISI -->
                    <div class="tab-pane" id="disposisi-container">
                        <div class="d-flex justify-content-between align-items-center mb-4"><h2 class="fw-light text-white m-0">Inbox Disposisi: <b class="text-warning" id="dispPageTitle">Direktur</b></h2><button class="btn btn-outline-light" onclick="refreshCurrentDisposisi()"><i class="fas fa-sync-alt"></i> Refresh</button></div><div class="card shadow-lg"><div class="card-header border-bottom"><i class="fas fa-tasks me-2"></i> Daftar Tunggu</div><div class="card-body"><div class="table-responsive"><table id="tableDisposisi" class="table table-striped table-hover table-sm w-100 align-middle"><thead><tr><th>Tanggal</th><th>Agenda</th><th>Pengirim</th><th>Perihal</th><th>File</th><th>Aksi</th></tr></thead><tbody></tbody></table></div></div></div>
                    </div>

                    <!-- ARSIP MASUK (FIXED) -->
                    <div class="tab-pane" id="arsip-masuk-content">
                        <div class="d-flex justify-content-between align-items-center mb-4"><h2 class="fw-light text-white m-0">Arsip <b class="text-info">Surat Masuk</b></h2><button class="btn btn-outline-light" onclick="loadDataMasuk()"><i class="fas fa-sync-alt"></i> Refresh Data</button></div><div class="card shadow-lg"><div class="card-header bg-light border-bottom"><i class="fas fa-table me-2"></i> Data Surat Masuk</div><div class="card-body"><div class="table-responsive">
                            <table id="tableMasuk" class="table table-striped table-hover table-sm w-100 align-middle">
                                <thead>
                                    <!-- FIXED HEADERS: 6 Columns -->
                                    <tr><th>Tgl Terima</th><th>Agenda</th><th>Pengirim</th><th>Perihal</th><th>Status</th><th class="text-center">Aksi</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div></div></div>
                    </div>
                    
                    <!-- ARSIP KELUAR (FIXED) -->
                    <div class="tab-pane" id="arsip-keluar-content">
                        <div class="d-flex justify-content-between align-items-center mb-4"><h2 class="fw-light text-white m-0">Arsip <b class="text-success">Surat Keluar</b></h2><button class="btn btn-outline-light" onclick="loadDataKeluar()"><i class="fas fa-sync-alt"></i> Refresh Data</button></div><div class="card shadow-lg"><div class="card-header bg-light border-bottom"><i class="fas fa-table me-2"></i> Data Surat Keluar</div><div class="card-body"><div class="table-responsive">
                            <table id="tableKeluar" class="table table-striped table-hover table-sm w-100 align-middle">
                                <thead>
                                    <!-- FIXED HEADERS: 8 Columns -->
                                    <tr><th>Agenda</th><th>Tgl Diterima</th><th>No. Surat</th><th>Tujuan</th><th>Perihal</th><th>Pembuat</th><th>Status</th><th>Aksi</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div></div></div>
                    </div>

                    <!-- SETTINGS PAGE (Super Admin) -->
                    <div class="tab-pane" id="settings-content">
                        <div class="d-flex justify-content-between align-items-center mb-4"><h2 class="fw-light text-white m-0">Pengaturan <b class="text-info">Pengguna</b></h2><button class="btn btn-outline-light" onclick="loadUsers()"><i class="fas fa-sync-alt"></i> Refresh</button></div><div class="card shadow-lg"><div class="card-header border-bottom"><i class="fas fa-users-cog me-2"></i> Daftar Pengguna</div><div class="card-body"><div class="table-responsive"><table id="tableUsers" class="table table-striped table-hover table-sm w-100 align-middle"><thead><tr><th>Email</th><th>Nama</th><th>Role</th><th>Status</th><th>Aksi</th></tr></thead><tbody></tbody></table></div></div></div>
                    </div>
                    
                    <!-- LOG PAGE (New) -->
                    <div class="tab-pane" id="log-content">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                             <h2 class="fw-light text-white m-0">Log <b class="text-danger">Aktivitas</b></h2>
                             <button class="btn btn-outline-light" onclick="loadLogs()"><i class="fas fa-sync-alt"></i> Refresh</button>
                        </div>
                        <div class="card shadow-lg">
                            <div class="card-header bg-white border-bottom text-danger">
                                <i class="fas fa-list-ul me-2"></i> Riwayat Aktivitas Sistem
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="tableLog" class="table table-striped table-hover table-sm w-100 align-middle">
                                        <thead>
                                            <tr><th>Waktu</th><th>User</th><th>Aksi</th><th>Detail</th></tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- MODAL EDIT SURAT KELUAR -->
    <div class="modal fade" id="modalEditSuratKeluar" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Edit Surat Keluar</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="formEditKeluar"><input type="hidden" id="editKeluarNoAgenda"><div class="mb-3"><label class="small text-white-50">No. Surat</label><input type="text" class="form-control" id="editKeluarNoSurat" required></div><div class="mb-3"><label class="small text-white-50">Tanggal Surat Diterima (Pencatatan)</label><input type="date" class="form-control" id="editKeluarTglDiterima" required></div>
    <!-- NEW FIELDS -->
    <div class="mb-3"><label class="small text-white-50">Tanggal Surat (Resmi)</label><input type="date" class="form-control" id="editKeluarTglSurat"></div>
    <div class="mb-3"><label class="small text-white-50">Tujuan</label><input type="text" class="form-control" id="editKeluarTujuan" required></div>
    <div class="mb-3"><label class="small text-white-50">Perihal</label><textarea class="form-control" id="editKeluarPerihal" rows="3" required></textarea></div>
    <div class="mb-3"><label class="small text-white-50">Pembuat Surat</label><input type="text" class="form-control" id="editKeluarPembuat"></div>
    </form></div><div class="modal-footer"><button type="button" class="btn btn-primary" onclick="saveEditKeluar()">Simpan Perubahan</button></div></div></div></div>

    <!-- MODAL EDIT SURAT MASUK (NEW) -->
    <div class="modal fade" id="modalEditSuratMasuk" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Edit Surat Masuk</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="formEditMasuk"><input type="hidden" id="editMasukNoAgenda"><div class="row"><div class="col-md-6 mb-3"><label class="small text-white-50">No. Agenda (Read-Only)</label><input type="text" class="form-control" id="editMasukAgendaDisplay" disabled></div><div class="col-md-6 mb-3"><label class="small text-white-50">No. Surat</label><input type="text" class="form-control" id="editMasukNoSurat" required></div></div><div class="row"><div class="col-md-6 mb-3"><label class="small text-white-50">Tgl Surat</label><input type="date" class="form-control" id="editMasukTglSurat" required></div><div class="col-md-6 mb-3"><label class="small text-white-50">Tgl Terima</label><input type="date" class="form-control" id="editMasukTglTerima" required></div></div><div class="mb-3"><label class="small text-white-50">Pengirim</label><input type="text" class="form-control" id="editMasukPengirim" required></div>
    <!-- ADDED: Kode Klarifikasi in Edit Modal -->
    <div class="mb-3"><label class="small text-white-50">Kode Klarifikasi</label><input class="form-control" list="listKodeKlarifikasiEdit" id="editMasukKode" placeholder="Ketik kode..."><datalist id="listKodeKlarifikasiEdit"></datalist></div>
    <div class="mb-3"><label class="small text-white-50">Perihal</label><textarea class="form-control" id="editMasukPerihal" rows="3" required></textarea></div></form></div><div class="modal-footer"><button type="button" class="btn btn-primary" onclick="saveEditMasuk()">Simpan Perubahan</button></div></div></div></div>

    <!-- MODAL EDIT USER -->
    <div class="modal fade" id="modalEditUser" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Edit Hak Akses User</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="formEditUser"><input type="hidden" id="editUserEmail">
    <!-- NEW: NAME EDITING -->
    <div class="mb-3"><label class="small text-white-50">Nama Lengkap</label><input type="text" class="form-control" id="editUserName" required></div>
    <div class="mb-3"><label class="small text-white-50">Role</label><select class="form-select" id="editUserRole"><option value="User">User Biasa</option><option value="Admin">Admin</option><option value="Super Admin">Super Admin</option></select></div><div class="mb-3"><label class="small text-white-50">Status</label><select class="form-select" id="editUserStatus"><option value="Aktif">Aktif</option><option value="Blokir">Blokir</option><option value="Pending">Pending</option></select></div><div class="mb-3"><label class="small text-white-50 d-block mb-2">Hak Akses Menu</label><div class="row"><div class="col-6"><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="input_masuk" id="perm_in_m"><label class="form-check-label text-white" for="perm_in_m">Input Masuk</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="input_keluar" id="perm_in_k"><label class="form-check-label text-white" for="perm_in_k">Input Keluar</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="arsip_masuk" id="perm_ar_m"><label class="form-check-label text-white" for="perm_ar_m">Arsip Masuk</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="arsip_keluar" id="perm_ar_k"><label class="form-check-label text-white" for="perm_ar_k">Arsip Keluar</label></div><div class="form-check mt-2"><input class="form-check-input perm-check" type="checkbox" value="disp_direktur" id="perm_dir"><label class="form-check-label text-white" for="perm_dir">Direktur</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="disp_wadir_admin" id="perm_wad_a"><label class="form-check-label text-white" for="perm_wad_a">Wadir Adm</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="disp_wadir_pelayanan" id="perm_wad_p"><label class="form-check-label text-white" for="perm_wad_p">Wadir Pel</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="disp_jf" id="perm_jf"><label class="form-check-label text-white" for="perm_jf">Jabatan Fung.</label></div></div><div class="col-6"><small class="text-info d-block mb-1">Kabag/Kabid:</small><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="disp_kabag_umum" id="perm_k1"><label class="form-check-label text-white" for="perm_k1">Kabag Umum</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="disp_kabag_keuangan" id="perm_k2"><label class="form-check-label text-white" for="perm_k2">Kabag Keu</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="disp_kabag_progpel" id="perm_k3"><label class="form-check-label text-white" for="perm_k3">Kabag Prog</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="disp_kabid_yanmed" id="perm_k4"><label class="form-check-label text-white" for="perm_k4">Kabid Yanmed</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="disp_kabid_keperawatan" id="perm_k5"><label class="form-check-label text-white" for="perm_k5">Kabid Kep</label></div><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="disp_kabid_penunjang" id="perm_k6"><label class="form-check-label text-white" for="perm_k6">Kabid Penunj</label></div></div>
    <!-- NEW PERMISSION: SETTINGS ADMIN -->
    <div class="col-12 mt-2 border-top border-secondary pt-2"><small class="text-warning fw-bold">Khusus Admin:</small><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="settings_admin" id="perm_settings"><label class="form-check-label text-white" for="perm_settings">Akses Pengaturan Pengguna (User Management)</label></div></div>
    <!-- NEW PERMISSION: BACKUP DATA -->
    <div class="col-12 mt-2 border-top border-secondary pt-2"><small class="text-warning fw-bold">Fitur Khusus:</small><div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="backup_data" id="perm_backup"><label class="form-check-label text-white" for="perm_backup">Akses Download Backup Data (Excel)</label></div></div>
    </div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-primary" onclick="saveUserPermissions()">Simpan Perubahan</button></div></div></div></div>
    
    <!-- MODAL MANAGE SUBORDINATES -->
    <div class="modal fade" id="modalManageSubordinates" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Atur Bawahan untuk: <span id="subordTargetName" class="text-warning"></span></h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="subordTargetEmail"><div class="mb-3"><input type="text" class="form-control" id="searchSubordinate" placeholder="Cari nama bawahan..." onkeyup="filterSubordinates()"></div><div id="subordinatesList" class="row g-2" style="max-height: 400px; overflow-y: auto;"></div></div><div class="modal-footer"><button type="button" class="btn btn-primary" onclick="saveSubordinates()">Simpan Tim</button></div></div></div></div>

    <!-- Other Modals -->
    <div class="modal fade" id="modalDisposisi" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Proses Disposisi: <span id="modalDispLevelTitle" class="text-warning"></span></h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="formDisposisiAction"><input type="hidden" id="actNoAgenda"><div class="alert alert-light border border-secondary text-dark mb-3 p-3 shadow-sm rounded"><small class="text-muted text-uppercase d-block mb-1 font-weight-bold">Perihal Surat:</small><span id="actPerihal" class="fw-bold fs-6"></span></div>
    
    <!-- ADDED: Previous Disposition Info Box -->
    <div id="prevDispInfo" class="alert alert-info border-info d-none">
        <strong id="prevDispLabel">Instruksi Sebelumnya:</strong>
        <p id="prevDispText" class="mb-0 fst-italic mt-1 text-dark"></p>
    </div>
    
    <div id="fieldDirektur" class="disp-field d-none"><label class="small text-info">Tujuan Wadir</label><select class="form-select mb-2" id="actTargetWadir"><option value="Wadir Pelayanan">Wadir Pelayanan</option><option value="Wadir Admin & Keuangan">Wadir Admin & Keuangan</option></select></div><div id="fieldWadir" class="disp-field d-none"><label class="small text-info">Tujuan Bidang/Bagian</label><select class="form-select mb-2" id="actTargetBidang"></select></div>
    
    <!-- UPDATE: CHANGED SELECT TO INPUT+DATALIST FOR MANUAL TYPING -->
    <div id="fieldKabid" class="disp-field d-none">
        <label class="small text-info">Tujuan JF (Pilih/Ketik Baru)</label>
        <input class="form-control mb-2" list="datalistTargetJF" id="actTargetJF" placeholder="Pilih atau Ketik Nama JF...">
        <datalist id="datalistTargetJF"></datalist>
    </div>
    
    <div id="fieldJF" class="disp-field d-none">
        <label class="small text-info">Tujuan Staf (Pilih/Ketik Baru)</label>
        <input class="form-control mb-2" list="datalistTargetStaf" id="actTargetStaf" placeholder="Pilih atau Ketik Nama Staf...">
        <datalist id="datalistTargetStaf"></datalist>
    </div>
    
    <label class="small text-white-50 mt-2">Isi Instruksi</label><textarea class="form-control mb-3" id="actInstruksi" rows="3" placeholder="Instruksi..."></textarea><label class="small text-white-50">Tanggal Proses</label><input type="date" class="form-control" id="actTgl" required></form></div><div class="modal-footer"><button type="button" class="btn btn-primary w-100" onclick="submitDisposisiLevel()">Kirim Disposisi</button></div></div></div></div>
    <div class="modal fade" id="modalHistory" tabindex="-1"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Riwayat</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="timelineContent" class="ps-2 pt-2"></div></div></div></div></div>

    <div id="loadingOverlay" style="display:none;"><div class="spinner-border text-info" style="width: 4rem; height: 4rem;"></div><div class="mt-4 fw-bold text-white fs-5">Sedang Memproses...</div></div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwptKDes4cyW6LqcgdoOIvLdqkF6U01A1BDWt8ADIbOsGrE6LlXabDDdnpH3HMUUiyNaA/exec"; 
        let currentLevel = ""; 
        let currentUserEmail = "";
        let allUsersCache = []; // Store list of users for subordinate selection
        const structureOrg = {
            "Wadir Pelayanan": ["Bidang Pelayanan Medis", "Bidang Pelayanan Keperawatan", "Bidang Pelayanan Penunjang"],
            "Wadir Admin & Keuangan": ["Bagian Adm dan Umum", "Bagian Keuangan", "Bagian Progpel"]
        };

        $(document).ready(function() {
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                currentUserEmail = sessionStorage.getItem('userEmail');
                showApp();
                loadCounters();
                loadRefCodes(); // Load codes on start
                renderSidebarPermissions();
                restoreState(); 
            }
            
            const today = new Date();
            document.querySelectorAll('input[type="date"]').forEach(el => el.valueAsDate = today);
            
            $('#sidebarCollapse, #sidebarCloseMobile').on('click', function() { $('#sidebar, #content').toggleClass('toggled'); });
            
            // OPTIONS UPDATED: Added destroy: true
            const dtConfig = { 
                language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/id.json" }, 
                pageLength: 10, 
                autoWidth: false,
                destroy: true  // Allow reinitialization
            };
            
            $('#tableDisposisi').DataTable(dtConfig);
            $('#tableMasuk').DataTable(dtConfig);
            $('#tableKeluar').DataTable(dtConfig);
            $('#tableLog').DataTable(dtConfig); // Init Log Table

            setupSimpleForm('#formSuratMasuk', 'simpan_masuk', 'Tercatat.');
            setupSimpleForm('#formSuratKeluar', 'simpan_keluar', 'Tercatat.');
            
            $('button[onclick^="activateTab"]').on('click', function (e) { $('.submenu .nav-link').removeClass('active'); });
        });

        // --- NEW: Load Ref Codes ---
        function loadRefCodes() {
            fetch(`${GAS_URL}?action=get_ref_codes`)
            .then(r => r.json())
            .then(r => {
                if (r.status === 'success' && r.data) {
                    const list = $('#listKodeKlarifikasi');
                    const listEdit = $('#listKodeKlarifikasiEdit');
                    list.empty();
                    listEdit.empty();
                    r.data.forEach(item => {
                        // Create option with value=code and text=desc
                        const option = `<option value="${item.code}">${item.desc}</option>`;
                        list.append(option);
                        listEdit.append(option);
                    });
                }
            });
        }

        // --- AUTH GOOGLE ---
        function handleCredentialResponse(response) {
            showLoading(true);
            fetch(GAS_URL, { 
                method: 'POST', 
                body: JSON.stringify({ type: 'google_login', credential: response.credential }) 
            })
            .then(r => r.json()).then(r => {
                showLoading(false);
                if (r.status === 'success') {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('userEmail', r.data.email);
                    sessionStorage.setItem('userRole', r.data.role);
                    sessionStorage.setItem('userPermissions', JSON.stringify(r.data.permissions));
                    sessionStorage.setItem('userSubordinates', JSON.stringify(r.data.subordinates)); // Store Subordinates
                    sessionStorage.setItem('userName', r.data.name);
                    
                    currentUserEmail = r.data.email;
                    showApp();
                    loadCounters();
                    loadRefCodes();
                    renderSidebarPermissions();
                } else {
                    Swal.fire({ icon: 'error', title: 'Login Gagal', text: r.message });
                }
            }).catch(e => { showLoading(false); Swal.fire('Error', 'Koneksi Gagal', 'error'); });
        }

        // --- PERMISSIONS RENDERER ---
        function renderSidebarPermissions() {
            const role = sessionStorage.getItem('userRole');
            const perms = JSON.parse(sessionStorage.getItem('userPermissions') || "[]");
            const name = sessionStorage.getItem('userName');
            
            $('#userDisplayName').text(name);
            $('#userRoleBadge').text(role);

            $('.restricted-feature').addClass('restricted-feature'); 
            
            if (role === 'Super Admin') {
                $('.restricted-feature').removeClass('restricted-feature');
                return;
            }

            if (perms && Array.isArray(perms)) {
                perms.forEach(p => {
                    $(`[data-perm="${p}"]`).removeClass('restricted-feature');
                });
            }
        }

        // --- SETTINGS & SUBORDINATE MGMT ---
        function openSettingsPage(element) {
            activateTab('settings-content', element, loadUsers);
        }

        function loadUsers() {
            showLoading(true);
            fetch(`${GAS_URL}?type=get_users_list`, { method: 'POST', body: JSON.stringify({ type: 'get_users_list', requestor: currentUserEmail }) })
            .then(r => r.json()).then(r => {
                showLoading(false);
                const dt = $('#tableUsers').DataTable();
                if ($.fn.DataTable.isDataTable('#tableUsers')) { dt.clear().destroy(); }
                const table = $('#tableUsers').DataTable({ language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/id.json" } });
                
                allUsersCache = r.data; // Cache for subordinate modal

                if (r.data) {
                    r.data.forEach(u => {
                        let btnEdit = `<button class="btn btn-sm btn-info text-white me-1" onclick='openEditUser(${JSON.stringify(u)})' title="Edit Akses"><i class="fas fa-edit"></i></button>`;
                        let btnTeam = `<button class="btn btn-sm btn-warning text-dark" onclick='openManageSubordinates(${JSON.stringify(u)})' title="Atur Bawahan"><i class="fas fa-users"></i></button>`;
                        table.row.add([ u.email, u.name, u.role, u.status, btnEdit + btnTeam ]);
                    });
                    table.draw();
                }
            });
        }

        function openEditUser(user) {
            $('#editUserEmail').val(user.email);
            // POPULATE NAME
            $('#editUserName').val(user.name);
            $('#editUserRole').val(user.role);
            $('#editUserStatus').val(user.status);
            $('.perm-check').prop('checked', false);
            try {
                const perms = JSON.parse(user.permissions);
                perms.forEach(p => { $(`.perm-check[value="${p}"]`).prop('checked', true); });
            } catch(e){}
            new bootstrap.Modal(document.getElementById('modalEditUser')).show();
        }

        function saveUserPermissions() {
            const perms = [];
            $('.perm-check:checked').each(function() { perms.push($(this).val()); });
            
            // INCLUDE NAME IN PAYLOAD
            const payload = { 
                type: 'update_user_permissions', 
                requestor: currentUserEmail, 
                targetEmail: $('#editUserEmail').val(), 
                name: $('#editUserName').val(), // Sent new name
                role: $('#editUserRole').val(), 
                status: $('#editUserStatus').val(), 
                permissions: JSON.stringify(perms) 
            };
            
            bootstrap.Modal.getInstance(document.getElementById('modalEditUser')).hide();
            showLoading(true);
            fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(r => r.json()).then(r => { showLoading(false); if(r.status==='success') { Swal.fire('Sukses', 'Data user diupdate', 'success'); loadUsers(); } else Swal.fire('Gagal', r.message, 'error'); });
        }

        // --- SUBORDINATE MANAGEMENT ---
        function openManageSubordinates(user) {
            $('#subordTargetName').text(user.name);
            $('#subordTargetEmail').val(user.email);
            
            const container = $('#subordinatesList');
            container.empty();
            
            // Current Subordinates of this user
            let currentSubs = [];
            try { currentSubs = JSON.parse(user.subordinates) || []; } catch(e){}

            // Populate List (Exclude self)
            allUsersCache.forEach(u => {
                if(u.email !== user.email) {
                    const isChecked = currentSubs.includes(u.name) ? 'checked' : '';
                    const html = `
                        <div class="col-md-6 sub-item">
                            <div class="form-check bg-dark bg-opacity-25 rounded p-2">
                                <input class="form-check-input subord-check ms-1" type="checkbox" value="${u.name}" id="sub_${u.email}" ${isChecked}>
                                <label class="form-check-label ms-2 text-white" for="sub_${u.email}">
                                    ${u.name} <small class="text-info d-block" style="font-size:0.7em">${u.role}</small>
                                </label>
                            </div>
                        </div>`;
                    container.append(html);
                }
            });
            new bootstrap.Modal(document.getElementById('modalManageSubordinates')).show();
        }

        function filterSubordinates() {
            const val = $('#searchSubordinate').val().toLowerCase();
            $('.sub-item').each(function() {
                const text = $(this).text().toLowerCase();
                $(this).toggle(text.indexOf(val) > -1);
            });
        }

        function saveSubordinates() {
            const subs = [];
            $('.subord-check:checked').each(function() { subs.push($(this).val()); });
            
            const payload = { 
                type: 'update_user_subordinates', 
                requestor: currentUserEmail, 
                targetEmail: $('#subordTargetEmail').val(), 
                subordinates: JSON.stringify(subs) 
            };
            
            bootstrap.Modal.getInstance(document.getElementById('modalManageSubordinates')).hide();
            showLoading(true);
            fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(r => r.json()).then(r => { showLoading(false); if(r.status==='success') { Swal.fire('Sukses', 'Tim berhasil diatur', 'success'); loadUsers(); } else Swal.fire('Gagal', r.message, 'error'); });
        }

        // --- DISPOSISI LOGIC with SUBORDINATE DROPDOWN (AUTO-ADD) ---
        function openModalAction(rowData) {
            $('#actNoAgenda').val(rowData[1]); $('#actPerihal').text(rowData[6]); 
            document.querySelector('#actTgl').valueAsDate = new Date(); $('#actInstruksi').val('');
            $('#modalDispLevelTitle').text(currentLevel.replace('_',' ').toUpperCase()); $('.disp-field').addClass('d-none');
            
            // --- SHOW PREVIOUS DISPOSITION INSTRUCTION ---
            $('#prevDispInfo').addClass('d-none'); // Reset default hidden
            let prevLabel = "";
            let prevText = "";

            if (currentLevel.includes('wadir')) {
                // Wadir sees Direktur's instruction
                prevLabel = "Instruksi Direktur:";
                prevText = rowData[9]; // Col 9 = Instruksi Direktur
            } else if (currentLevel.startsWith('kabid') || currentLevel.startsWith('kabag')) {
                // Kabid/Kabag sees Wadir's instruction
                prevLabel = "Instruksi Wadir:";
                prevText = rowData[12]; // Col 12 = Instruksi Wadir
            } else if (currentLevel === 'jf') {
                // JF sees Kabid/Kabag's instruction
                prevLabel = "Instruksi Kabag/Kabid:";
                prevText = rowData[15]; // Col 15 = Instruksi Kabid
            }

            if (prevLabel && prevText && prevText !== "") {
                $('#prevDispLabel').text(prevLabel);
                $('#prevDispText').text('"' + prevText + '"');
                $('#prevDispInfo').removeClass('d-none');
            }
            // ---------------------------------------------
            
            if(currentLevel === 'direktur') $('#fieldDirektur').removeClass('d-none');
            else if (currentLevel.includes('wadir')) {
                $('#fieldWadir').removeClass('d-none');
                let html = (structureOrg[rowData[8]] || []).map(o => `<option value="${o}">${o}</option>`).join('');
                $('#actTargetBidang').html(html);
            } 
            else if (currentLevel.startsWith('kabid') || currentLevel.startsWith('kabag')) {
                $('#fieldKabid').removeClass('d-none');
                // Use datalist ID
                populateSubordinateDropdown('#datalistTargetJF');
                $('#actTargetJF').val('');
            }
            else if (currentLevel === 'jf') {
                $('#fieldJF').removeClass('d-none');
                // Use datalist ID
                populateSubordinateDropdown('#datalistTargetStaf');
                $('#actTargetStaf').val('');
            }
            new bootstrap.Modal(document.getElementById('modalDisposisi')).show();
        }

        function populateSubordinateDropdown(selector) {
            const subsJson = sessionStorage.getItem('userSubordinates');
            const dataList = $(selector);
            dataList.empty();
            
            let subs = [];
            try { subs = JSON.parse(subsJson); } catch(e){}
            
            if(subs && subs.length > 0) {
                subs.forEach(name => {
                    dataList.append(`<option value="${name}"></option>`);
                });
            }
        }

        function submitDisposisiLevel() {
            const formData = { type: 'update_disposisi_level', email: currentUserEmail, level: currentLevel, noAgenda: $('#actNoAgenda').val(), tglDisposisi: $('#actTgl').val(), instruksi: $('#actInstruksi').val() };
            if(currentLevel === 'direktur') formData.targetWadir = $('#actTargetWadir').val();
            if(currentLevel.includes('wadir')) formData.targetBidang = $('#actTargetBidang').val();
            
            // HANDLE INPUT+DATALIST
            if(currentLevel.startsWith('kabid') || currentLevel.startsWith('kabag')) {
                formData.targetJF = $('#actTargetJF').val();
            }
            if(currentLevel === 'jf') {
                formData.targetStaf = $('#actTargetStaf').val();
            }
            
            // Validate
            if((currentLevel.startsWith('kabid') || currentLevel.startsWith('kabag')) && !formData.targetJF) {
                return Swal.fire('Error', 'Nama JF tujuan harus diisi', 'warning');
            }
            if(currentLevel === 'jf' && !formData.targetStaf) {
                return Swal.fire('Error', 'Nama Staf tujuan harus diisi', 'warning');
            }

            bootstrap.Modal.getInstance(document.getElementById('modalDisposisi')).hide();
            showLoading(true);
            
            sendData(formData, () => { 
                // OPTIMISTIC UPDATE: Update Session Storage with new name if manually typed
                let newName = "";
                if(currentLevel.startsWith('kabid') || currentLevel.startsWith('kabag')) newName = formData.targetJF;
                if(currentLevel === 'jf') newName = formData.targetStaf;
                
                if (newName) {
                    let subs = JSON.parse(sessionStorage.getItem('userSubordinates') || "[]");
                    // Case insensitive check
                    const exists = subs.some(s => s.trim().toLowerCase() === newName.trim().toLowerCase());
                    if (!exists) {
                        subs.push(newName.trim());
                        sessionStorage.setItem('userSubordinates', JSON.stringify(subs));
                    }
                }
                
                refreshCurrentDisposisi(); 
                loadCounters(); 
                Swal.fire('Sukses', 'Disposisi Terkirim', 'success'); 
            });
        }

        // --- REST SAME AS BEFORE ---
        function restoreState() {
            const lastBtnId = sessionStorage.getItem('lastActiveBtn');
            if(lastBtnId && $('#'+lastBtnId).length) {
                if($('#'+lastBtnId).closest('.submenu').length) {
                    $('#submenuDisposisi').addClass('show');
                    $('a[href="#submenuDisposisi"]').removeClass('collapsed').attr('aria-expanded', 'true');
                }
                $('#'+lastBtnId).click();
            }
        }
        function loadCounters() {
            fetch(`${GAS_URL}?action=get_counts`).then(r=>r.json()).then(r => {
                if(r.status === 'success') {
                    setCount('direktur', r.data.direktur);
                    setCount('wadir_admin', r.data.wadir_admin);
                    setCount('wadir_pelayanan', r.data.wadir_pelayanan);
                    setCount('kabag_umum', r.data.kabag_umum);
                    setCount('kabag_keuangan', r.data.kabag_keuangan);
                    setCount('kabag_progpel', r.data.kabag_progpel);
                    setCount('kabid_yanmed', r.data.kabid_yanmed);
                    setCount('kabid_keperawatan', r.data.kabid_keperawatan);
                    setCount('kabid_penunjang', r.data.kabid_penunjang);
                    setCount('jf', r.data.jf);
                }
            });
            fetch(`${GAS_URL}?action=get_auto_numbers`).then(r=>r.json()).then(r => {
                if(r.status === 'success') {
                    $('input[name="noAgenda"]').val(r.data.masuk);
                    $('#outNoAgenda').val(r.data.keluar);
                }
            });
        }
        function openBookingModal() {
            Swal.fire({
                title: 'Booking Nomor Agenda', text: 'Jumlah nomor:', input: 'number',
                showCancelButton: true, confirmButtonText: 'Booking', showLoaderOnConfirm: true,
                preConfirm: (amount) => {
                    return fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ type: 'booking_keluar', amount: amount, email: currentUserEmail }) })
                    .then(response => response.json());
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    $('#outNoAgenda').val(result.value.data.nextAvailable);
                    Swal.fire('Berhasil', `Nomor berikutnya: ${result.value.data.nextAvailable}`, 'success');
                }
            });
        }
        function setupSimpleForm(selector, type, msg) {
            $(selector).on('submit', async function(e) {
                e.preventDefault();
                showLoading(true);
                let fileData = "", fileName = "";
                const fileInput = $(this).find('input[type="file"]')[0];
                if (fileInput.files.length > 0) {
                    try { fileData = await readFileToBase64(fileInput.files[0]); fileName = fileInput.files[0].name; } 
                    catch(e) { showLoading(false); return Swal.fire('Error File', '', 'error'); }
                }
                const formData = { type: type, fileData: fileData, fileName: fileName, email: currentUserEmail };
                $(this).serializeArray().forEach(item => formData[item.name] = item.value);
                
                sendData(formData, () => {
                    $(selector)[0].reset();
                    document.querySelectorAll('input[type="date"]').forEach(el => el.valueAsDate = new Date());
                    loadCounters(); 
                    Swal.fire('Sukses', msg, 'success');
                });
            });
        }
        function logout() {
            Swal.fire({
                title: 'Konfirmasi Logout',
                text: "Anda yakin ingin keluar?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Keluar'
            }).then((result) => {
                if (result.isConfirmed) {
                    sessionStorage.removeItem('isLoggedIn');
                    sessionStorage.removeItem('lastActiveBtn'); 
                    $('#appContent').stop().hide(); 
                    $('#loginSection').stop().css('display', 'flex').hide().fadeIn(300);
                    setTimeout(() => { location.reload(); }, 500); 
                }
            });
        }
        function activateTab(tabId, element, callback) {
            if(element && element.id) sessionStorage.setItem('lastActiveBtn', element.id);
            $('#sidebar .nav-link').removeClass('active'); $('.submenu .nav-link').removeClass('active'); 
            if(element) $(element).addClass('active');
            $('.tab-pane').removeClass('show active'); 
            const target = $('#' + tabId); target.addClass('active');
            setTimeout(() => { target.addClass('show'); }, 50);
            if ($(window).width() <= 991) $('#sidebar, #content').removeClass('toggled');
            if (callback) callback();
        }
        function openDisposisiPage(level, element) {
            if(element && element.id) sessionStorage.setItem('lastActiveBtn', element.id);
            currentLevel = level; activateTab('disposisi-container', element, refreshCurrentDisposisi);
            let title = level.toUpperCase();
            if(level.startsWith('kabag_') || level.startsWith('kabid_')) title = level.replace('_', ' ').toUpperCase();
            if(level.includes('wadir')) title = level.replace('_', ' ').toUpperCase();
            $('#dispPageTitle').text(title);
        }
        function refreshCurrentDisposisi() {
            showLoading(true);
            fetch(`${GAS_URL}?action=read_pending&level=${currentLevel}`).then(r=>r.json()).then(r => {
                showLoading(false);
                const dt = $('#tableDisposisi').DataTable(); dt.clear();
                if(r.data) r.data.forEach(row => {
                    let btnFile = row[7] ? `<a href="${row[7]}" target="_blank" class="btn btn-sm btn-outline-info"><i class="fas fa-file-pdf"></i></a>` : '-';
                    let btnProses = `<button class="btn btn-sm btn-warning fw-bold" onclick='openModalAction(${JSON.stringify(row)})'>Proses</button>`;
                    dt.row.add([ new Date(row[4]).toLocaleDateString('id-ID'), row[1], row[5], row[6], btnFile, btnProses ]);
                });
                dt.draw();
            });
        }
        function loadDataMasuk() {
            fetch(`${GAS_URL}?action=read_masuk`).then(r=>r.json()).then(r=>{
                const dt = $('#tableMasuk').DataTable(); dt.clear();
                if(r.data) r.data.forEach(row => {
                    // Mapping: 0:Ts, 1:Agenda, 2:NoSurat, 3:TglSrt, 4:TglTerima, 5:Pengirim, 6:Perihal, 7:File, ... 20:Status
                    const userRole = sessionStorage.getItem('userRole'); // GET USER ROLE
                    
                    let dateTerima = '-';
                    if (row[4]) { const d = new Date(row[4]); if (!isNaN(d.getTime())) dateTerima = d.toLocaleDateString('id-ID'); }
                    
                    // Linkify Perihal
                    let perihalHtml = row[7] ? `<a href="${row[7]}" target="_blank" class="fw-bold text-decoration-none text-primary">${row[6]} <i class="fas fa-external-link-alt small"></i></a>` : row[6];

                    let status = `<span class="badge bg-secondary">${row[20]}</span>`;
                    if(row[20] === 'Selesai') status = `<span class="badge bg-success">Selesai</span>`;
                    
                    let btnHistory = `<button class="btn btn-sm btn-light text-primary border" onclick='viewHistory(${JSON.stringify(row)})'><i class="fas fa-eye"></i></button>`;
                    
                    // CONDITIONAL EDIT BUTTON
                    let btnEdit = '';
                    if (userRole === 'Admin' || userRole === 'Super Admin') {
                        // Use correct escaping for onclick
                        btnEdit = `<button class="btn btn-sm btn-light text-warning border ms-1" onclick='openEditMasuk(${JSON.stringify(row).replace(/'/g, "&apos;")})'><i class="fas fa-pencil"></i></button>`;
                    }
                    
                    // NEW: Print Button (Yellow)
                    let btnPrint = `<button class="btn btn-sm btn-dark text-warning border ms-1" onclick="printDisposisi('${row[1]}')"><i class="fas fa-print"></i></button>`;
                    
                    let actions = `<div class="d-flex gap-1 justify-content-center">${btnHistory}${btnEdit}${btnPrint}</div>`;

                    // Add Row: TglTerima, Agenda, Pengirim, Perihal(Link), Status, Actions
                    dt.row.add([ dateTerima, row[1], row[5], perihalHtml, status, actions ]);
                });
                // Sort by Column 1 (Agenda) Descending
                dt.order([1, 'desc']).draw();
            });
        }

        // --- NEW: Print Disposisi Logic ---
        function printDisposisi(noAgenda) {
            Swal.fire({
                title: 'Sedang Memproses PDF...',
                text: 'Mohon tunggu, lembar disposisi sedang dibuat.',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });
            
            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ type: 'cetak_disposisi', noAgenda: noAgenda })
            })
            .then(r => r.json())
            .then(r => {
                if (r.status === 'success') {
                    // Convert Base64 to Blob
                    const byteCharacters = atob(r.data.pdfBase64);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], {type: "application/pdf"});
                    
                    // Trigger Download
                    const link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    link.download = r.data.fileName;
                    link.click();
                    
                    Swal.close();
                } else {
                    Swal.fire('Gagal', r.message, 'error');
                }
            })
            .catch(e => {
                Swal.fire('Error', 'Gagal membuat PDF', 'error');
            });
        }

        function viewHistory(row) {
            let html = createTimelineItem(true, "SURAT DITERIMA", `Agenda: ${row[1]}`, `Tgl Surat: ${new Date(row[3]).toLocaleDateString('id-ID')}`, row[0]);
            if(row[8]) html += createTimelineItem(true, "DIREKTUR", `Ke: ${row[8]}`, row[9], row[10]); else html += createTimelineItem(false, "DIREKTUR", "Menunggu Proses", "", "");
            if(row[11]) html += createTimelineItem(true, "WADIR", `Ke: ${row[11]}`, row[12], row[13]);
            if(row[14]) html += createTimelineItem(true, "KABAG/KABID", `Ke: ${row[14]}`, row[15], row[16]);
            if(row[17]) html += createTimelineItem(true, "JF", `Ke Staf: ${row[17]}`, row[18], row[19]);
            $('#timelineContent').html(html);
            new bootstrap.Modal(document.getElementById('modalHistory')).show();
        }
        function formatDateTime(dateString) {
            if(!dateString) return '';
            const d = new Date(dateString);
            if(isNaN(d.getTime())) return '';
            return d.toLocaleDateString('id-ID') + ' ' + d.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
        }
        function createTimelineItem(isDone, title, target, note, date) {
            let cls = isDone ? 'done' : '';
            let dateStr = date ? `<span class="badge bg-dark ms-2">${formatDateTime(date)}</span>` : '';
            return `<div class="timeline-item ${cls}"><div class="fw-bold text-warning small d-flex justify-content-between"><span>${title}</span>${dateStr}</div><div class="timeline-content mt-1"><div class="fw-bold small mb-1">${target}</div><div class="text-white-50 small fst-italic">"${note || '-'}"</div></div></div>`;
        }
        function loadDataKeluar() {
            fetch(`${GAS_URL}?action=read_keluar`).then(r=>r.json()).then(r=>{
                const dt = $('#tableKeluar').DataTable(); dt.clear();
                if(r.data) r.data.forEach(row => {
                    // Mapping UPDATED: 0:Ts, 1:Agenda, 2:NoSurat, 3:TglDiterima, 4:TglSurat(Resmi), 5:Tujuan, 6:Perihal, 7:File, 8:Pembuat, 9:Status
                    const userRole = sessionStorage.getItem('userRole'); // GET USER ROLE

                    let dateDiterima = '-';
                    if (row[3]) { const d = new Date(row[3]); if (!isNaN(d.getTime())) dateDiterima = d.toLocaleDateString('id-ID'); }
                    
                    // UPDATED: Linkify Perihal if File Exists (row[7])
                    let perihalHtml = row[7] ? `<a href="${row[7]}" target="_blank" class="fw-bold text-decoration-none text-primary">${row[6]} <i class="fas fa-external-link-alt small"></i></a>` : row[6];
                    
                    let btnFile = row[7] ? `<a href="${row[7]}" target="_blank" class="btn btn-sm btn-outline-info"><i class="fas fa-file-pdf"></i></a>` : '-';
                    let statusText = row[9] || "Proses";
                    let status = statusText === 'Selesai' ? `<span class="badge bg-success">Selesai</span>` : `<span class="badge bg-warning text-dark">Proses</span> <button class="btn btn-sm btn-outline-success ms-2 py-0" onclick="updateStatusSelesai('${row[1]}')"><i class="fas fa-check"></i></button>`;
                    
                    // CONDITIONAL EDIT BUTTON
                    let btnEdit = '';
                    if (userRole === 'Admin' || userRole === 'Super Admin') {
                        // Use correct escaping for onclick
                        btnEdit = `<button class="btn btn-sm btn-light text-primary border py-0" onclick='openEditKeluar(${JSON.stringify(row).replace(/'/g, "&apos;")})'><i class="fas fa-pencil"></i></button>`;
                    }

                    let actions = `<div class="d-flex gap-1">${status}${btnEdit}</div>`;
                    
                    // Use perihalHtml instead of row[6]
                    dt.row.add([ row[1], dateDiterima, row[2], row[5], perihalHtml, (row[8] || ""), statusText, actions ]);
                });
                // Sort by Column 0 (Agenda) Descending
                dt.order([0, 'desc']).draw();
            });
        }
        function updateStatusSelesai(noSurat) {
            // Default Today
            const d = new Date();
            const today = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');

            Swal.fire({ title: 'Selesaikan Surat?', html: `<p class="text-muted">Masukkan Tanggal Surat Resmi (setelah TTD):</p><input type="date" id="swal-date-input" class="swal2-input" value="${today}">`, focusConfirm: false, showCancelButton: true, confirmButtonText: 'Selesai', preConfirm: () => { const dateVal = document.getElementById('swal-date-input').value; if (!dateVal) { Swal.showValidationMessage('Tanggal Surat Resmi harus diisi'); } return dateVal; }
            }).then((result) => { if(result.isConfirmed) { showLoading(true); fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ type: 'update_status_keluar', noAgenda: noSurat, tglSurat: result.value }) }).then(r=>r.json()).then(r=>{ showLoading(false); if(r.status==='success') { Swal.fire('Berhasil', 'Status surat selesai & Tanggal Resmi disimpan.', 'success'); loadDataKeluar(); } else { Swal.fire('Gagal', r.message, 'error'); }}); } });
        }

        // --- NEW: Load Log Data ---
        function loadLogs() {
            showLoading(true);
            fetch(`${GAS_URL}?action=read_log`)
            .then(r => r.json())
            .then(r => {
                showLoading(false);
                const dt = $('#tableLog').DataTable(); 
                dt.clear();
                
                if (r.data && r.data.length > 0) {
                    r.data.forEach(row => {
                        // 0:Timestamp, 1:Email, 2:Action, 3:Details
                        let timeStr = row[0];
                        try {
                            const d = new Date(row[0]);
                            if (!isNaN(d.getTime())) {
                                timeStr = d.toLocaleDateString('id-ID') + ' ' + d.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
                            }
                        } catch(e) {}
                        
                        dt.row.add([
                            timeStr,
                            `<span class="text-primary fw-bold">${row[1]}</span>`,
                            `<span class="badge bg-info text-dark">${row[2]}</span>`,
                            row[3]
                        ]);
                    });
                    // Sort by newest first (assuming timestamp is first col)
                    dt.order([0, 'desc']).draw();
                } else {
                    dt.draw();
                }
            })
            .catch(e => {
                showLoading(false);
                Swal.fire('Error', 'Gagal memuat log aktivitas', 'error');
            });
        }
        
        // ... (Rest of functions remain same) ...
        
        // --- NEW: Edit Surat Masuk Logic ---
        function openEditMasuk(row) {
            // Row Mapping: 0:Timestamp, 1:No_Agenda, 2:No_Surat, 3:Tgl_Surat, 4:Tgl_Terima, 5:Pengirim, 6:Perihal...
            $('#editMasukNoAgenda').val(row[1]);
            $('#editMasukAgendaDisplay').val(row[1]); // Display only
            $('#editMasukNoSurat').val(row[2]);
            if(row[3]) { const d = new Date(row[3]); if(!isNaN(d)) document.getElementById('editMasukTglSurat').valueAsDate = d; }
            if(row[4]) { const d = new Date(row[4]); if(!isNaN(d)) document.getElementById('editMasukTglTerima').valueAsDate = d; }
            $('#editMasukPengirim').val(row[5]);
            $('#editMasukPerihal').val(row[6]);
            
            // New Kode Klarifikasi (Index 21 if exists)
            if(row[21]) {
                 $('#editMasukKode').val(row[21]);
            } else {
                 $('#editMasukKode').val('');
            }
            
            new bootstrap.Modal(document.getElementById('modalEditSuratMasuk')).show();
        }

        function saveEditMasuk() {
            const payload = {
                type: 'edit_surat_masuk',
                email: currentUserEmail,
                noAgenda: $('#editMasukNoAgenda').val(),
                noSurat: $('#editMasukNoSurat').val(),
                tglSurat: $('#editMasukTglSurat').val(),
                tglTerima: $('#editMasukTglTerima').val(),
                pengirim: $('#editMasukPengirim').val(),
                perihal: $('#editMasukPerihal').val(),
                kodeKlarifikasi: $('#editMasukKode').val() // New Field
            };
            
            bootstrap.Modal.getInstance(document.getElementById('modalEditSuratMasuk')).hide();
            showLoading(true);
            
            sendData(payload, () => {
                Swal.fire('Sukses', 'Data surat masuk berhasil diperbarui', 'success');
                loadDataMasuk();
            });
        }
        
        // --- NEW: Edit Surat Keluar Logic (ADDED) ---
        function openEditKeluar(row) {
             // Mapping UPDATED: 0:Ts, 1:Agenda, 2:NoSurat, 3:TglDiterima, 4:TglSurat(Resmi), 5:Tujuan, 6:Perihal, 7:File, 8:Pembuat, 9:Status
            $('#editKeluarNoAgenda').val(row[1]);
            $('#editKeluarNoSurat').val(row[2]);
            
            if(row[3]) { const d = new Date(row[3]); if(!isNaN(d)) document.getElementById('editKeluarTglDiterima').valueAsDate = d; }
            if(row[4]) { const d = new Date(row[4]); if(!isNaN(d)) document.getElementById('editKeluarTglSurat').valueAsDate = d; }
            
            $('#editKeluarTujuan').val(row[5]);
            $('#editKeluarPerihal').val(row[6]);
            $('#editKeluarPembuat').val(row[8]);
            
            new bootstrap.Modal(document.getElementById('modalEditSuratKeluar')).show();
        }

        function saveEditKeluar() {
            const payload = {
                type: 'edit_surat_keluar',
                email: currentUserEmail,
                noAgenda: $('#editKeluarNoAgenda').val(),
                noSurat: $('#editKeluarNoSurat').val(),
                tglDiterima: $('#editKeluarTglDiterima').val(),
                tglSurat: $('#editKeluarTglSurat').val(), // Tgl Resmi
                tujuan: $('#editKeluarTujuan').val(),
                perihal: $('#editKeluarPerihal').val(),
                pembuat: $('#editKeluarPembuat').val()
            };
            
            bootstrap.Modal.getInstance(document.getElementById('modalEditSuratKeluar')).hide();
            showLoading(true);
            
            sendData(payload, () => {
                Swal.fire('Sukses', 'Data surat keluar berhasil diperbarui', 'success');
                loadDataKeluar();
            });
        }

        function setCount(id, c) { $(`#count-${id}`).text(c).toggleClass('has-data', c > 0); }
        function showApp() { $('#loginSection').fadeOut(300, ()=> $('#appContent').fadeIn(300)); }
        function showLoading(show) { $('#loadingOverlay').css('display', show ? 'flex' : 'none'); }
        function sendData(data, cb) { fetch(GAS_URL, { method: 'POST', body: JSON.stringify(data) }).then(r=>r.json()).then(r=> { showLoading(false); if(r.status==='success') cb(); else Swal.fire('Gagal', r.message, 'error'); }); }
        function readFileToBase64(file) { return new Promise((res, rej) => { const r = new FileReader(); r.readAsDataURL(file); r.onload = () => res(r.result); r.onerror = e => rej(e); }); }

        // --- NEW: BACKUP FEATURE ---
        function downloadBackup() {
            showLoading(true);
            fetch(`${GAS_URL}`, { 
                method: 'POST', 
                body: JSON.stringify({ type: 'get_backup_data', requestor: currentUserEmail }) 
            })
            .then(r => r.json())
            .then(r => {
                showLoading(false);
                if (r.status === 'success') {
                    generateZipBackup(r.data.suratMasuk, r.data.suratKeluar);
                } else {
                    Swal.fire('Gagal', r.message, 'error');
                }
            })
            .catch(e => {
                showLoading(false);
                Swal.fire('Error', 'Gagal mengunduh data backup.', 'error');
            });
        }

        function generateZipBackup(dataMasuk, dataKeluar) {
            // 1. Create Workbooks using SheetJS
            const wb = XLSX.utils.book_new();
            
            // Surat Masuk Sheet
            const wsMasuk = XLSX.utils.aoa_to_sheet(dataMasuk);
            XLSX.utils.book_append_sheet(wb, wsMasuk, "SuratMasuk");
            
            // Surat Keluar Sheet
            const wsKeluar = XLSX.utils.aoa_to_sheet(dataKeluar);
            XLSX.utils.book_append_sheet(wb, wsKeluar, "SuratKeluar");

            // 2. Generate XLSX Blob
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });

            // 3. Create ZIP using JSZip
            const zip = new JSZip();
            zip.file("Data_SIMAS.xlsx", wbout);

            // Generate filename: backupsimas [yyyy-mm-dd hh-mm]
            const now = new Date();
            const timeString = now.getFullYear() + "-" + 
                               String(now.getMonth()+1).padStart(2, '0') + "-" + 
                               String(now.getDate()).padStart(2, '0') + " " + 
                               String(now.getHours()).padStart(2, '0') + "-" + 
                               String(now.getMinutes()).padStart(2, '0');
            const zipFilename = `backupsimas ${timeString}.zip`;

            // 4. Download ZIP
            zip.generateAsync({type:"blob"})
            .then(function(content) {
                saveAs(content, zipFilename);
                Swal.fire('Sukses', 'Backup data berhasil diunduh.', 'success');
            });
        }

        // --- NEW: AUTO-BACKUP TRIGGER ACTIVATION ---
        function activateAutoBackup() {
            Swal.fire({
                title: 'Aktifkan Email Backup Harian?',
                text: "Sistem akan mengirimkan data backup otomatis ke email admin (rusita.aprilia30@gmail.com) setiap jam 23:00.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ya, Aktifkan'
            }).then((result) => {
                if(result.isConfirmed) {
                    showLoading(true);
                    fetch(GAS_URL, { 
                        method: 'POST', 
                        body: JSON.stringify({ type: 'setup_auto_backup', requestor: currentUserEmail }) 
                    })
                    .then(r => r.json())
                    .then(r => {
                        showLoading(false);
                        if(r.status === 'success') {
                            Swal.fire('Sukses', r.message, 'success');
                        } else {
                            Swal.fire('Gagal', r.message, 'error');
                        }
                    })
                    .catch(e => {
                        showLoading(false);
                        Swal.fire('Error', 'Koneksi gagal', 'error');
                    });
                }
            });
        }
    </script>
</body>
</html>
