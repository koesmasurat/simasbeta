<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMAS KOESMA V25 (Ultimate)</title>
    <link rel="icon" href="https://github.com/koesmasurat/simas/blob/main/logo%20rsud%202%20png.png?raw=true" type="image/png">
    
    <!-- Libraries -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Playfair+Display:ital@1&display=swap" rel="stylesheet">
    
    <!-- Excel Export & Utils -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.1/tsparticles.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { --glass-bg: rgba(255, 255, 255, 0.1); --glass-border: rgba(255, 255, 255, 0.2); --text-light: #f8f9fa; --emerald-accent: #f97316; --sidebar-width: 310px; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #9a3412 0%, #0f172a 100%); background-attachment: fixed; color: var(--text-light); min-height: 100vh; overflow-x: hidden; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(12px); border: 1px solid var(--glass-border); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .white-panel { background: #ffffff !important; color: #333 !important; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); overflow: hidden; }
        .white-panel .card { border: none; box-shadow: none; }
        .white-panel h2, .white-panel h3, .white-panel label { color: #333 !important; }
        
        .glass-form-card { background: rgba(0, 0, 0, 0.6) !important; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: white !important; padding: 20px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3); }
        .glass-form-card label { color: #f8f9fa !important; }
        .glass-form-card .form-control, .glass-form-card .form-select { background-color: #ffffff; color: #333333; border: none; }

        .dash-card { transition: transform 0.2s; cursor: pointer; border-radius: 12px; overflow: hidden; position: relative; }
        .dash-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .dash-icon { position: absolute; right: 15px; bottom: 15px; font-size: 3rem; opacity: 0.2; }
        
        #loginSection { height: 100vh; display: flex; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 200; }
        .login-card { width: 100%; max-width: 450px; padding: 2.5rem; text-align: center; border-radius: 16px; position: relative; z-index: 201; }
        #door-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: flex; pointer-events: none; }
        .door-panel { width: 50%; height: 100%; background: linear-gradient(135deg, #9a3412 0%, #0f172a 100%); position: relative; transition: transform 1.5s cubic-bezier(0.77, 0, 0.175, 1); box-shadow: 0 0 50px rgba(0,0,0,0.5); z-index: 101; }
        .door-open #door-left { transform: translateX(-100%); } .door-open #door-right { transform: translateX(100%); }
        
        #tsparticles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 150; pointer-events: none; transition: opacity 1.5s; }
        #tsparticles.in-background { z-index: 0 !important; opacity: 0.2 !important; filter: blur(2px); }
        
        #appContent { display: none; width: 100%; min-height: 100vh; position: relative; z-index: 50; } 
        #sidebar { min-width: var(--sidebar-width); background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(15px); border-right: 1px solid var(--glass-border); position: fixed; height: 100vh; z-index: 1000; display: flex; flex-direction: column; transition: 0.3s; }
        #sidebar.toggled { margin-left: calc(var(--sidebar-width) * -1); } 
        #content { width: 100%; padding: 20px; margin-left: var(--sidebar-width); transition: 0.3s; } #content.toggled { margin-left: 0; }
        
        @media (max-width: 768px) {
            #sidebar { margin-left: calc(var(--sidebar-width) * -1); } #sidebar.toggled { margin-left: 0; }
            #content { margin-left: 0; }
        }

        .nav-link { color: rgba(255,255,255,0.8); border-radius: 6px; padding: 10px 15px; margin-bottom: 4px; cursor: pointer; display: flex; align-items: center; transition: 0.2s; }
        .nav-link:hover { background: rgba(255,255,255,0.15); color: #fff; padding-left: 20px; } 
        .nav-link.active { background: linear-gradient(90deg, var(--emerald-accent), transparent); color: #fff; border-left: 4px solid #fff; } 
        .nav-link i { width: 25px; margin-right: 10px; }
        
        #loadingOverlay { position: fixed; inset: 0; z-index: 99999; display: none; justify-content: center; align-items: center; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .page-section { display: none; animation: fadeIn 0.4s; } .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .role-widget { background: rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.2); }
        
        /* Timeline for History */
        .timeline { border-left: 3px solid #3b82f6; margin-left: 10px; padding-left: 20px; }
        .timeline-item { position: relative; margin-bottom: 20px; }
        .timeline-item::before { content: ''; position: absolute; left: -26px; top: 0; width: 15px; height: 15px; background: #3b82f6; border-radius: 50%; }
        .timeline-date { font-size: 0.8rem; color: #6c757d; }

        /* --- FIXED ADMIN TABLE STYLES --- */
        #tableAdmin { table-layout: fixed; width: 100%; font-size: 0.9rem; }
        #tableAdmin th, #tableAdmin td { vertical-align: middle; white-space: normal; word-wrap: break-word; }
        
        /* Kolom Jabatan */
        #tableAdmin th:nth-child(1) { width: 35%; } 
        /* Kolom Level */
        #tableAdmin th:nth-child(2) { width: 10%; text-align: center; } 
        #tableAdmin td:nth-child(2) { text-align: center; font-weight: bold; }
        /* Kolom Pejabat */
        #tableAdmin th:nth-child(3) { width: 30%; }
        /* Kolom Lock */
        #tableAdmin th:nth-child(4) { width: 10%; text-align: center; }
        #tableAdmin td:nth-child(4) { text-align: center; }
        /* Kolom Aksi */
        #tableAdmin th:nth-child(5) { width: 15%; text-align: center; }
        #tableAdmin td:nth-child(5) { text-align: center; }
        
        /* Action Buttons Grid */
        .action-group { display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; }
    </style>
</head>
<body>
    <div id="tsparticles"></div>
    <div id="door-overlay"><div id="door-left" class="door-panel"></div><div id="door-right" class="door-panel"></div></div>
    
    <div id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-light mb-3"></div>
            <h5 class="text-white">Memproses...</h5>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="loginSection">
        <div class="glass-panel login-card">
            <img src="https://github.com/koesmasurat/simas/blob/main/logo%20rsud%202%20png.png?raw=true" width="100" class="mb-3">
            <h3 class="fw-bold text-white">SIMAS KOESMA</h3>
            <p class="text-white-50">V25 Enterprise (Integrated)</p>
            <div class="d-flex justify-content-center mt-4">
                <div id="g_id_onload" data-client_id="783459415718-mp0vsmd2lopajf2ut0aqc6drjrs95pu8.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_prompt="false"></div>
                <div class="g_id_signin" data-type="standard" data-size="large" data-theme="filled_blue" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
            </div>
        </div>
    </div>

    <!-- APP -->
    <div id="appContent">
        <nav id="sidebar">
            <div class="p-3 text-center border-bottom border-white-50">
                <div class="d-flex align-items-center justify-content-center gap-2 mb-2">
                    <img src="https://github.com/koesmasurat/simas/blob/main/logo%20rsud%202%20png.png?raw=true" width="40">
                    <div class="text-start lh-1"><div class="fw-bold small">RSUD KOESMA</div><div class="text-warning" style="font-size: 0.7rem;">SIMAS V25</div></div>
                </div>
            </div>
            <div class="flex-grow-1 overflow-auto p-3">
                <div class="role-widget">
                    <small class="text-white-50 text-uppercase" style="font-size:0.7rem;">Posisi Aktif:</small>
                    <div class="fw-bold text-warning" id="sideJob">...</div>
                    <div class="small text-white" id="sideName">...</div>
                    <button class="btn btn-sm btn-outline-light w-100 mt-2" onclick="switchRoleModal()" id="btnSwitchRole" style="display:none"><i class="fas fa-exchange-alt"></i> Ganti</button>
                </div>

                <div class="nav-link active" onclick="nav('dashboard', this)"><i class="fas fa-home"></i> Dashboard</div>
                <div class="nav-link" onclick="loadInbox(this)"><i class="fas fa-inbox"></i> Inbox Dinas <span class="badge bg-danger ms-auto" id="badgeInbox">0</span></div>

                <div class="my-2 border-top border-white-50"></div>
                <div class="fw-bold text-white-50 px-3 py-1 small">INPUT</div>
                <div class="nav-link" onclick="openInputMasuk(this)"><i class="fas fa-envelope-open-text"></i> Surat Masuk</div>
                <div class="nav-link" onclick="openInputKeluar(this)"><i class="fas fa-paper-plane"></i> Surat Keluar</div>

                <div class="my-2 border-top border-white-50"></div>
                <div class="fw-bold text-white-50 px-3 py-1 small">ARSIP & LAPORAN</div>
                <div class="nav-link" onclick="loadArsip('masuk', this)"><i class="fas fa-archive"></i> Arsip Masuk</div>
                <div class="nav-link" onclick="loadArsip('keluar', this)"><i class="fas fa-file-export"></i> Arsip Keluar</div>

                <div id="adminMenu" style="display:none;">
                    <div class="my-2 border-top border-white-50"></div>
                    <div class="fw-bold text-danger px-3 py-1 small">ADMIN</div>
                    <div class="nav-link text-warning" onclick="openAdminMapping(this)"><i class="fas fa-users-cog"></i> User Mapping</div>
                </div>
            </div>
            <div class="p-3 bg-dark bg-opacity-25 border-top border-white-50"><button class="btn btn-danger w-100" onclick="location.reload()"><i class="fas fa-sign-out-alt me-2"></i> Keluar</button></div>
        </nav>

        <div id="content">
            <button class="btn btn-outline-light mb-3" onclick="$('#sidebar, #content').toggleClass('toggled')"><i class="fas fa-bars"></i> Menu</button>
            <div id="alertUnlock" class="alert alert-warning glass-panel text-dark border-0 mb-3" style="display:none;">
                <i class="fas fa-lock-open me-2"></i> <strong>Profil Terbuka:</strong> Anda bisa mengubah jabatan. Hubungi Admin untuk mengunci.
            </div>

            <!-- Dashboard -->
            <div id="page-dashboard" class="page-section active">
                <div class="white-panel p-4">
                    <div class="welcome-header d-flex justify-content-between align-items-center">
                        <div><h2 class="fw-bold mb-1 text-white">Selamat Datang</h2><p class="mb-0 text-white-50">Posisi: <strong class="text-warning" id="dashJob">...</strong></p></div>
                        <div class="text-end text-white"><h5 class="mb-0" id="dashName">...</h5></div>
                    </div>
                    <div class="row g-4">
                        <div class="col-md-6"><div class="card dash-card bg-primary text-white h-100" onclick="loadInbox()"><div class="card-body"><h3>Inbox</h3><h2 id="statInbox">0</h2><p>Surat Menunggu</p><i class="fas fa-inbox dash-icon"></i></div></div></div>
                        <div class="col-md-6"><div class="card dash-card bg-success text-white h-100" onclick="openInputMasuk()"><div class="card-body"><h3>Input</h3><h2><i class="fas fa-plus"></i></h2><p>Surat Baru</p><i class="fas fa-file-alt dash-icon"></i></div></div></div>
                    </div>
                </div>
            </div>

            <!-- Input Masuk -->
            <div id="page-inputMasuk" class="page-section">
                <div class="glass-form-card">
                    <h3 class="fw-bold mb-4 border-bottom pb-2">Registrasi Surat Masuk</h3>
                    <form id="formInputMasuk">
                        <div class="row g-3">
                            <div class="col-md-4"><label>No Agenda</label><div class="input-group"><input type="number" name="noAgenda" id="im_agenda" class="form-control" required><button class="btn btn-warning" type="button" onclick="openBooking('masuk')">Booking</button></div></div>
                            <div class="col-md-4"><label>Tgl Surat</label><input type="date" name="tglSurat" class="form-control" required></div>
                            <div class="col-md-4"><label>Tgl Terima</label><input type="date" name="tglTerima" class="form-control" required></div>
                            <div class="col-md-6"><label>Pengirim</label><input type="text" name="pengirim" class="form-control" required></div>
                            <div class="col-md-6"><label>No Surat</label><input type="text" name="noSurat" class="form-control" required></div>
                            <div class="col-12"><label>Perihal</label><textarea name="perihal" class="form-control" rows="3" required></textarea></div>
                            <div class="col-12"><label>File</label><input type="file" id="fileMasuk" class="form-control"></div>
                            <div class="col-12 mt-3"><button type="submit" class="btn btn-primary w-100">Simpan</button></div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Input Keluar -->
            <div id="page-inputKeluar" class="page-section">
                <div class="glass-form-card">
                    <h3 class="fw-bold mb-4 border-bottom pb-2">Registrasi Surat Keluar</h3>
                    <form id="formInputKeluar">
                        <div class="row g-3">
                            <div class="col-md-6"><label>No Agenda</label><div class="input-group"><input type="number" name="noAgenda" id="ik_agenda" class="form-control" required><button class="btn btn-warning" type="button" onclick="openBooking('keluar')">Booking</button></div></div>
                            <div class="col-md-6"><label>Tgl Surat</label><input type="date" name="tglSurat" class="form-control" required></div>
                            <div class="col-12"><label>Tujuan</label><input type="text" name="tujuan" class="form-control" required></div>
                            <div class="col-12"><label>Pembuat</label><select name="pembuat" class="form-select" id="selectPembuat"></select></div>
                            <div class="col-12"><label>Perihal</label><textarea name="perihal" class="form-control" rows="3" required></textarea></div>
                            <div class="col-12"><label>File</label><input type="file" id="fileKeluar" class="form-control"></div>
                            <div class="col-12 mt-3"><button type="submit" class="btn btn-success w-100">Simpan</button></div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Table Section (Inbox & Arsip) -->
            <div id="page-tables" class="page-section">
                <div class="white-panel p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="fw-bold m-0" id="tableTitle">Data Table</h3>
                        <div class="d-flex gap-2">
                            <!-- Filter Tanggal (Hanya muncul di Arsip) -->
                            <div id="dateFilter" class="d-flex gap-1" style="display:none;">
                                <input type="date" id="filterStart" class="form-control form-control-sm">
                                <input type="date" id="filterEnd" class="form-control form-control-sm">
                                <button class="btn btn-primary btn-sm" onclick="refreshTable()"><i class="fas fa-search"></i></button>
                            </div>
                            <button class="btn btn-success btn-sm" id="btnExport" onclick="exportToExcel()" style="display:none;"><i class="fas fa-file-excel"></i> Export</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="refreshTable()"><i class="fas fa-sync"></i></button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered align-middle" id="mainTable">
                            <thead class="table-light"><tr><th>Agenda</th><th>Info Surat</th><th>Status</th><th>Aksi</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin -->
            <div id="page-admin" class="page-section">
                <div class="white-panel p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="fw-bold text-danger">Manajemen Struktur & User</h3>
                        <button class="btn btn-success btn-sm" onclick="openAdminEdit(null)"><i class="fas fa-plus-circle"></i> Tambah Jabatan</button>
                    </div>
                    <button class="btn btn-primary btn-sm mb-3" onclick="loadAdminData()"><i class="fas fa-sync"></i> Refresh</button>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped" id="tableAdmin">
                            <thead class="table-dark">
                                <tr>
                                    <th>Jabatan (ID/Nama)</th>
                                    <th>Level</th>
                                    <th>Pejabat (User Email)</th>
                                    <th>Lock</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <!-- Onboarding -->
    <div class="modal fade" id="modalOnboarding" data-bs-backdrop="static" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">Pilih Jabatan</h5></div><div class="modal-body"><input id="searchJob" class="form-control mb-3" placeholder="Cari..."><div class="list-group" id="jobList" style="max-height:300px;overflow:auto"></div></div></div></div></div>
    
    <!-- Disposisi -->
    <div class="modal fade" id="modalDisposisi" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning"><h5 class="modal-title">Disposisi</h5></div><div class="modal-body"><input type="hidden" id="dispAgenda"><div id="dispTargets" class="mb-3 border p-2 rounded bg-light" style="max-height:200px;overflow:auto"></div><textarea id="dispInstruksi" class="form-control" rows="3" placeholder="Instruksi..."></textarea><button class="btn btn-warning w-100 mt-3" onclick="sendDisposisi()">Kirim</button></div></div></div></div>

    <!-- Booking -->
    <div class="modal fade" id="modalBooking" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-secondary text-white"><h5 class="modal-title">Booking</h5></div><div class="modal-body"><input type="hidden" id="bookCat"><div class="alert alert-info">Next: <strong id="bookNext">...</strong></div><input id="bookVal" type="number" class="form-control mb-2"><input id="bookNote" class="form-control mb-2" placeholder="Catatan"><button class="btn btn-primary w-100" onclick="submitBooking()">Booking</button></div></div></div></div>

    <!-- Role Switcher -->
    <div class="modal fade" id="modalRoleSwitch" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">Pilih Posisi</h5></div><div class="modal-body p-0"><div class="list-group list-group-flush" id="roleListContainer"></div></div></div></div></div>

    <!-- History Modal -->
    <div class="modal fade" id="modalHistory" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-info text-white"><h5 class="modal-title">History Surat</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="historyTimeline" class="timeline"></div></div></div></div></div>

    <!-- Admin Edit Modal (NEW) -->
    <div class="modal fade" id="modalAdminEdit" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Edit Struktur / User</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="adminTabs">
                        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabStruct">Detail Jabatan</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabUser">User Assigned</a></li>
                    </ul>
                    <div class="tab-content">
                        <!-- Structure Form -->
                        <div class="tab-pane fade show active" id="tabStruct">
                            <form id="formAdminStruct">
                                <div class="mb-2"><label>ID Jabatan (Kode Unik)</label><input id="adm_id" class="form-control" required></div>
                                <div class="mb-2"><label>Nama Jabatan</label><input id="adm_nama" class="form-control" required></div>
                                <div class="mb-2"><label>Parent ID (Atasan)</label><input id="adm_parent" class="form-control" placeholder="Kosongkan jika Direktur"></div>
                                <div class="mb-2"><label>Level (1-5)</label><input type="number" id="adm_level" class="form-control" required></div>
                                <button type="submit" class="btn btn-danger w-100 mt-3">Simpan Struktur</button>
                            </form>
                        </div>
                        <!-- User Assignment Form -->
                        <div class="tab-pane fade" id="tabUser">
                            <form id="formAdminUser">
                                <input type="hidden" id="adm_assign_id"> <!-- ID Jabatan -->
                                <div class="mb-3">
                                    <label>Email Pejabat Saat Ini</label>
                                    <input type="email" id="adm_email" class="form-control" placeholder="user@gmail.com">
                                    <small class="text-muted">Ganti email ini untuk memindahkan jabatan ke orang lain secara paksa.</small>
                                </div>
                                <button type="submit" class="btn btn-warning w-100">Update Pejabat</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwj9_nDaa2szQr7_UYLrlb0dZe_q0cassO6IfDmp7KICy5jUvAz5C0C8hGk8bQUPPfcYA/exec";
        let currentUser = null;
        let activeJob = null;
        let currentTableMode = '';
        let allPositions = [];
        let adminDataList = []; // Global store for admin data

        $(document).ready(function() {
            tsParticles.load("tsparticles", {
                fpsLimit: 60,
                particles: {
                    number: { value: 30, density: { enable: true, value_area: 800 } },
                    color: { value: "#ffffff" },
                    shape: { type: "image", image: [
                        { src: "data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23ffffff' d='M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4L236.8 313.6c11.4 8.5 27 8.5 38.4 0L492.8 150.4c12.1-9.1 19.2-23.3 19.2-38.4c0-26.5-21.5-48-48-48H48zM0 176V384c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V176L294.4 339.2c-22.8 17.1-54 17.1-76.8 0L0 176z'/%3E%3C/svg%3E", width: 32, height: 32 },
                            { src: "data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23ffffff' d='M464 64H48C21.5 64 0 85.5 0 112v288c0 26.5 21.5 48 48 48h416c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48zM48 96h416c8.8 0 16 7.2 16 16v41.4c-21.9 5.6-32 26.7-32 26.7H48s-10.1-21.1-32-26.7V112c0-8.8 7.2-16 16-16zm416 320H48c-8.8 0-16-7.2-16-16V192.6c21.9 5.6 32 26.7 32 26.7h416s10.1-21.1 32-26.7v127.4c0 8.8-7.2 16 16 16z'/%3E%3C/svg%3E", width: 32, height: 32 },
                            { src: "data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 384 512'%3E%3Cpath fill='%23ffffff' d='M224 136V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zm160-14.1v6.1H256V0h6.1c6.4 0 12.5 2.5 17 7l97.9 98c4.5 4.5 7 10.6 7 16.9z'/%3E%3C/svg%3E", width: 32, height: 32 }
                    ]},
                    opacity: { value: 0.6, random: true },
                    size: { value: 20, random: true },
                    move: { enable: true, speed: 2 }
                }
            });
            if($(window).width()<=768){$('#sidebar').addClass('toggled');$('#content').addClass('toggled');}
            
            // Set Default Dates for Filter
            const today = new Date().toISOString().split('T')[0];
            const lastMonth = new Date(); lastMonth.setMonth(lastMonth.getMonth()-1);
            $('#filterEnd').val(today);
            $('#filterStart').val(lastMonth.toISOString().split('T')[0]);
        });

        // AUTH
        function handleCredentialResponse(r) {
            showLoading(true);
            fetch(GAS_URL, {method:'POST', body:JSON.stringify({type:'google_login', credential:r.credential})})
            .then(r=>r.json()).then(res=>{
                showLoading(false);
                if(res.status==='success'){
                    currentUser = res.data;
                    $('#tsparticles').addClass('in-background');
                    $('#loginSection').fadeOut(500, ()=>{$('#door-overlay').addClass('door-open');setTimeout(()=>{ $('#appContent').fadeIn(500); initApp(); },300);});
                } else Swal.fire('Error', res.message, 'error');
            });
        }

        function initApp() {
            $('#sideName').text(currentUser.nama); $('#dashName').text(currentUser.nama);
            if(currentUser.isSuperAdmin) $('#adminMenu').show();
            if(currentUser.positions.length>0) { setActiveJob(currentUser.positions[0]); if(currentUser.positions.length>1) $('#btnSwitchRole').show(); }
            else { $('#sideJob').text("Belum Ada Jabatan"); openOnboarding(false); }
            if(!currentUser.isLocked && !currentUser.profileIncomplete) $('#alertUnlock').show();
        }

        function setActiveJob(job) {
            activeJob = job;
            $('#sideJob').text(job.nama); $('#dashJob').text(job.nama);
            $('#selectPembuat').html(`<option value="${job.id}">${job.nama}</option>`);
            loadInbox();
        }

        function nav(pageId, el) {
            $('.nav-link').removeClass('active'); if(el) $(el).addClass('active');
            $('.page-section').removeClass('active'); $(`#page-${pageId}`).addClass('active');
        }
        function showLoading(show) { $('#loadingOverlay').css('display', show?'flex':'none'); }

        // ONBOARDING
        function openOnboarding(closable) {
            const m = new bootstrap.Modal(document.getElementById('modalOnboarding'), {backdrop:closable?true:'static', keyboard:closable});
            m.show();
            fetch(GAS_URL, {method:'POST', body:JSON.stringify({type:'get_available_positions'})})
            .then(r=>r.json()).then(res=>{ allPositions=res.data; renderJobList(allPositions); });
        }
        function renderJobList(list) {
            const c=$('#jobList'); c.empty();
            list.forEach(p=>{
                const b = p.pejabat ? '<span class="badge bg-warning text-dark">Terisi</span>' : '<span class="badge bg-success">Kosong</span>';
                c.append(`<button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="claim('${p.id}')"><div><strong>${p.nama}</strong><br><small>${p.id}</small></div>${b}</button>`);
            });
        }
        $('#searchJob').on('keyup', function(){ const v=$(this).val().toLowerCase(); renderJobList(allPositions.filter(p=>p.nama.toLowerCase().includes(v))); });
        function claim(id) {
            if(!confirm("Klaim jabatan ini?")) return;
            showLoading(true);
            fetch(GAS_URL, {method:'POST', body:JSON.stringify({type:'claim_position', email:currentUser.email, jabatanId:id})})
            .then(r=>r.json()).then(r=>{ showLoading(false); if(r.status==='success') location.reload(); else Swal.fire('Gagal', r.message, 'error'); });
        }

        // ROLE SWITCH
        function switchRoleModal() {
            const c=$('#roleListContainer'); c.empty();
            currentUser.positions.forEach((p,i)=>c.append(`<button class="list-group-item list-group-item-action ${p.id===activeJob.id?'active':''}" onclick="selectRole(${i})">${p.nama}</button>`));
            new bootstrap.Modal(document.getElementById('modalRoleSwitch')).show();
        }
        function selectRole(i) { setActiveJob(currentUser.positions[i]); bootstrap.Modal.getInstance(document.getElementById('modalRoleSwitch')).hide(); }

        // DATA
        function openInputMasuk(el) { nav('inputMasuk', el); fetchNextAgenda('get_last_agenda_masuk', '#im_agenda'); }
        function openInputKeluar(el) { nav('inputKeluar', el); fetchNextAgenda('get_last_agenda_keluar', '#ik_agenda'); }
        function fetchNextAgenda(type, el) { fetch(GAS_URL, {method:'POST', body:JSON.stringify({type:type})}).then(r=>r.json()).then(r=>{if(r.status==='success')$(el).val(r.data.nextAgenda)}); }

        $('#formInputMasuk').on('submit', async function(e){e.preventDefault(); submitForm(this, 'simpan_masuk', '#fileMasuk')});
        $('#formInputKeluar').on('submit', async function(e){e.preventDefault(); submitForm(this, 'simpan_keluar', '#fileKeluar')});

        async function submitForm(form, type, fileId) {
            showLoading(true);
            const f=$(fileId)[0].files[0]; let fd="", fn=""; if(f){fd=await readFile(f);fn=f.name;}
            const d={type:type, fileData:fd, fileName:fn};
            $(form).serializeArray().forEach(x=>d[x.name]=x.value);
            fetch(GAS_URL, {method:'POST', body:JSON.stringify(d)}).then(r=>r.json()).then(r=>{
                showLoading(false); if(r.status==='success'){Swal.fire('Sukses','Tersimpan','success');$(form).trigger('reset');} else Swal.fire('Gagal',r.message,'error');
            });
        }
        function readFile(f){return new Promise(r=>{const fr=new FileReader();fr.onload=()=>r(fr.result);fr.readAsDataURL(f)})}

        // TABLES
        function loadInbox(el) {
            currentTableMode='inbox'; $('#tableTitle').text('Inbox Dinas'); 
            $('#dateFilter').hide(); $('#btnExport').hide();
            nav('tables', el); fetchData(`action=read_inbox&jabatanId=${activeJob.id}&level=${activeJob.level}`);
        }
        function loadArsip(type, el) {
            currentTableMode=`arsip_${type}`; $('#tableTitle').text(`Arsip ${type}`);
            $('#dateFilter').css('display', 'flex'); $('#btnExport').show();
            nav('tables', el); 
            const start = $('#filterStart').val(); const end = $('#filterEnd').val();
            fetchData(`action=read_arsip_${type}&start=${start}&end=${end}`);
        }
        function refreshTable() { if(currentTableMode==='inbox') loadInbox(); else { const t=currentTableMode.split('_')[1]; loadArsip(t); } }

        function fetchData(params) {
            showLoading(true);
            fetch(`${GAS_URL}?${params}`).then(r=>r.json()).then(r=>{
                showLoading(false); const tb=$('#mainTable tbody'); tb.empty();
                if(currentTableMode==='inbox') {$('#statInbox').text(r.data.length); $('#badgeInbox').text(r.data.length);}
                
                r.data.forEach(d=>{
                    let act="";
                    if(currentTableMode==='inbox') {
                        if(activeJob.level<4) act=`<button class="btn btn-warning btn-sm" onclick="openDisposisi('${d.agenda}')">Disposisi</button>`;
                        else act=`<button class="btn btn-success btn-sm" onclick="finishTask('${d.agenda}')">Selesai</button>`;
                    } else {
                        if(d.file) act=`<a href="${d.file}" target="_blank" class="btn btn-outline-primary btn-sm"><i class="fas fa-paperclip"></i></a>`;
                        if(currentTableMode==='arsip_masuk') act+=` <button class="btn btn-outline-dark btn-sm" onclick="printDisp('${d.agenda}')"><i class="fas fa-print"></i></button>`;
                        act+=` <button class="btn btn-info btn-sm text-white" onclick="showHistory('${d.agenda}')"><i class="fas fa-history"></i></button>`;
                    }
                    tb.append(`<tr><td class="fw-bold">${d.agenda}<br><small class="text-muted">${d.tglSurat||''}</small></td><td><div class="fw-bold">${d.perihal}</div><small class="text-muted">${d.pengirim||d.tujuan||''}</small>${d.instruksi?`<div class="text-danger small border-start border-danger ps-2 mt-1">Note: ${d.instruksi}</div>`:''}</td><td><span class="badge bg-secondary">${d.status||'-'}</span></td><td>${act}</td></tr>`);
                });
            });
        }

        // ACTIONS
        function openDisposisi(a) { $('#dispAgenda').val(a); $('#dispTargets').html('Loading...'); new bootstrap.Modal(document.getElementById('modalDisposisi')).show(); fetch(GAS_URL, {method:'POST', body:JSON.stringify({type:'get_subordinates', jabatanId:activeJob.id})}).then(r=>r.json()).then(r=>{ const t=$('#dispTargets'); t.empty(); r.data.forEach(s=>t.append(`<div class="form-check"><input class="form-check-input sub-chk" type="checkbox" value="${s.id}"><label class="form-check-label fw-bold">${s.nama} (${s.pejabat})</label></div>`)); }); }
        function sendDisposisi() { const ids=[]; $('.sub-chk:checked').each(function(){ids.push($(this).val())}); if(ids.length===0) return alert('Pilih tujuan'); showLoading(true); bootstrap.Modal.getInstance(document.getElementById('modalDisposisi')).hide(); fetch(GAS_URL, {method:'POST', body:JSON.stringify({type:'submit_disposisi', agenda:$('#dispAgenda').val(), targetIds:ids.join(','), instruksi:$('#dispInstruksi').val(), myLevel:activeJob.level})}).then(r=>r.json()).then(r=>{ showLoading(false); if(r.status==='success') { Swal.fire('Terkirim','','success'); loadInbox(); } }); }
        function finishTask(a) { const n=prompt("Catatan:"); if(!n) return; showLoading(true); fetch(GAS_URL, {method:'POST', body:JSON.stringify({type:'finish_disposition', agenda:a, executorName:currentUser.nama, note:n})}).then(r=>r.json()).then(r=>{ showLoading(false); loadInbox(); }); }
        
        function openBooking(c) { $('#bookCat').val(c); new bootstrap.Modal(document.getElementById('modalBooking')).show(); fetch(GAS_URL, {method:'POST', body:JSON.stringify({type:c==='keluar'?'get_last_agenda_keluar':'get_last_agenda_masuk'})}).then(r=>r.json()).then(r=>{$('#bookNext').text(r.data.nextAgenda); $('#bookVal').val(r.data.nextAgenda)}); }
        function submitBooking() { showLoading(true); fetch(GAS_URL, {method:'POST', body:JSON.stringify({type:'booking_agenda', category:$('#bookCat').val(), targetAgenda:$('#bookVal').val(), email:currentUser.email, note:$('#bookNote').val()})}).then(r=>r.json()).then(r=>{ showLoading(false); if(r.status==='success') { bootstrap.Modal.getInstance(document.getElementById('modalBooking')).hide(); Swal.fire('Berhasil','','success'); } else Swal.fire('Gagal',r.message,'error'); }); }

        function showHistory(agenda) {
            new bootstrap.Modal(document.getElementById('modalHistory')).show();
            $('#historyTimeline').html('<div class="text-center p-3">Loading history...</div>');
            fetch(`${GAS_URL}?action=get_history_surat&agenda=${agenda}`).then(r=>r.json()).then(r=>{
                const t = $('#historyTimeline'); t.empty();
                if(r.status==='success') {
                    r.data.forEach(h => {
                        t.append(`<div class="timeline-item"><div class="fw-bold">${h.title}</div><div class="timeline-date">${h.date}</div><div class="small">${h.desc}</div></div>`);
                    });
                } else t.html('Data tidak ditemukan.');
            });
        }

        function printDisp(agenda) { window.open(`${GAS_URL}?action=print_disposisi&agenda=${agenda}`, '_blank'); }

        // EXPORT EXCEL
        function exportToExcel() {
            const table = document.getElementById('mainTable');
            const wb = XLSX.utils.table_to_book(table, {sheet: "Data"});
            XLSX.writeFile(wb, `Export_${currentTableMode}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // --- ADMIN FUNCTIONS ---
        function openAdminMapping(el) { nav('admin', el); loadAdminData(); }
        
        function loadAdminData() { 
            showLoading(true); 
            fetch(GAS_URL, {method:'POST', body:JSON.stringify({type:'admin_get_mapping', requestor:currentUser.email})})
            .then(r=>r.json())
            .then(r=>{ 
                showLoading(false); 
                const t=$('#tableAdmin tbody'); t.empty(); 
                adminDataList = r.data; // Simpan ke global
                r.data.forEach((u, index) => { 
                    const lockBtn = u.is_locked ? 
                        `<button class="btn btn-danger btn-sm" onclick="toggleLock('${u.pejabat_email}',false)"><i class="fas fa-lock"></i></button>` : 
                        `<button class="btn btn-success btn-sm" onclick="toggleLock('${u.pejabat_email}',true)"><i class="fas fa-lock-open"></i></button>`;
                    
                    // Gunakan index array untuk akses data, lebih aman
                    const editBtn = `<button class="btn btn-warning btn-sm" onclick='openAdminEditIndex(${index})'><i class="fas fa-edit"></i></button>`;
                    
                    t.append(`<tr>
                        <td><div style="white-space:normal;"><strong>${u.id}</strong><br>${u.nama_jabatan}</div></td>
                        <td>${u.level}</td>
                        <td><div style="white-space:normal; word-break:break-word;">${u.pejabat_email || '<span class="text-muted fst-italic">Kosong</span>'}</div></td>
                        <td>${lockBtn}</td>
                        <td><div class="action-group">${editBtn}</div></td>
                    </tr>`); 
                }); 
            }); 
        }

        function toggleLock(email, status) { 
            if(!email) return Swal.fire("Error", "Belum ada user di jabatan ini", "warning");
            showLoading(true); 
            fetch(GAS_URL, {method:'POST', body:JSON.stringify({type:'admin_toggle_lock', requestor:currentUser.email, targetEmail:email, newStatus:status})})
            .then(r=>r.json()).then(r=>loadAdminData()); 
        }

        function openAdminEditIndex(index) {
            const data = adminDataList[index];
            openAdminEdit(data);
        }

        // Open Modal Add/Edit
        function openAdminEdit(data) {
            const modal = new bootstrap.Modal(document.getElementById('modalAdminEdit'));
            
            if (data) {
                // EDIT MODE
                $('#adm_id').val(data.id).prop('readonly', true); // ID cannot change
                $('#adm_nama').val(data.nama_jabatan);
                $('#adm_parent').val(data.parent);
                $('#adm_level').val(data.level);
                
                // User Tab Pre-fill
                $('#adm_assign_id').val(data.id);
                $('#adm_email').val(data.pejabat_email);
                
                // Show Struct Tab first
                new bootstrap.Tab(document.querySelector('#adminTabs a[href="#tabStruct"]')).show();
            } else {
                // ADD NEW MODE
                $('#formAdminStruct')[0].reset();
                $('#adm_id').prop('readonly', false);
                $('#adm_level').val(4); // Default
                new bootstrap.Tab(document.querySelector('#adminTabs a[href="#tabStruct"]')).show();
            }
            
            modal.show();
        }

        // Handle Form Submit: Structure
        $('#formAdminStruct').on('submit', function(e) {
            e.preventDefault();
            const payload = {
                type: 'admin_save_structure',
                requestor: currentUser.email,
                id: $('#adm_id').val(),
                nama: $('#adm_nama').val(),
                parent: $('#adm_parent').val(),
                level: $('#adm_level').val()
            };
            
            showLoading(true);
            fetch(GAS_URL, {method:'POST', body:JSON.stringify(payload)})
            .then(r=>r.json())
            .then(r=>{
                showLoading(false);
                if(r.status==='success') {
                    bootstrap.Modal.getInstance(document.getElementById('modalAdminEdit')).hide();
                    Swal.fire("Sukses", "Struktur berhasil disimpan", "success");
                    loadAdminData();
                } else Swal.fire("Gagal", r.message, "error");
            });
        });

        // Handle Form Submit: User Assignment
        $('#formAdminUser').on('submit', function(e) {
            e.preventDefault();
            const payload = {
                type: 'admin_assign_user',
                requestor: currentUser.email,
                jabatanId: $('#adm_assign_id').val(),
                emailPejabat: $('#adm_email').val()
            };
            
            showLoading(true);
            fetch(GAS_URL, {method:'POST', body:JSON.stringify(payload)})
            .then(r=>r.json())
            .then(r=>{
                showLoading(false);
                if(r.status==='success') {
                    bootstrap.Modal.getInstance(document.getElementById('modalAdminEdit')).hide();
                    Swal.fire("Sukses", "Pejabat berhasil diupdate", "success");
                    loadAdminData();
                } else Swal.fire("Gagal", r.message, "error");
            });
        });
    </script>
</body>
</html>
